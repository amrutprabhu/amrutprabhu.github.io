<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/icon.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/icon.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Spring Cloud Gateway Keycloak OAuth2 OIDC Integration | RefactorFirst</title><meta name="robots" content="follow, index"/><meta name="description" content="In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC)."/><meta property="og:url" content="https://refactorfirst.com/spring-cloud-gateway-keycloak-oauth2-openid-connect"/><meta property="og:type" content="article"/><meta property="og:site_name" content="RefactorFirst"/><meta property="og:description" content="In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC)."/><meta property="og:title" content="Spring Cloud Gateway Keycloak OAuth2 OIDC Integration"/><meta property="og:image" content="https://refactorfirst.com/static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/amrutprabhu42"/><meta name="twitter:title" content="Spring Cloud Gateway Keycloak OAuth2 OIDC Integration"/><meta name="twitter:description" content="In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC)."/><meta name="twitter:image" content="https://refactorfirst.com/static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg"/><meta property="article:published_time" content="2021-09-02T00:00:00.000Z"/><link rel="canonical" href="https://refactorfirst.com/spring-cloud-gateway-keycloak-oauth2-openid-connect"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://refactorfirst.com/2021/spring-cloud-gateway-keycloak-oauth2-openid-connect"
  },
  "headline": "Spring Cloud Gateway Keycloak OAuth2 OIDC Integration",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://refactorfirst.com/static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg"
    }
  ],
  "datePublished": "2021-09-02T00:00:00.000Z",
  "dateModified": "2021-09-02T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Amrut Prabhu"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Amrut Prabhu",
    "logo": {
      "@type": "ImageObject",
      "url": "https://refactorfirst.com/static/images/favicons/icon.png"
    }
  },
  "description": "In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC)."
}</script><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/5227e983b097ec3e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5227e983b097ec3e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-1aed8795b16b27b2.js" defer=""></script><script src="/_next/static/chunks/main-a8532ea7c2505ecc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9e8cd4f3c1e3eec8.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/207-4f91422181f853c0.js" defer=""></script><script src="/_next/static/chunks/984-e059826b5bf22bce.js" defer=""></script><script src="/_next/static/chunks/883-9cd53d582322e5e7.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-28f0421685e6788f.js" defer=""></script><script src="/_next/static/noK4yT0ecC1tFZf8SofZV/_buildManifest.js" defer=""></script><script src="/_next/static/noK4yT0ecC1tFZf8SofZV/_ssgManifest.js" defer=""></script><script src="/_next/static/noK4yT0ecC1tFZf8SofZV/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v11/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="RefactorFirst" href="/"><div class="flex items-center justify-between"><div class="mr-3"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img srcSet="static/favicons/icon.png?imwidth=64 1x, static/favicons/icon.png?imwidth=128 2x" src="static/favicons/icon.png?imwidth=128" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="h-6 text-2xl font-semibold sm:block">RefactorFirst</div></div></a></div><div class="mt-6"></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/posts">Posts</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="w-8 h-8 p-1 ml-1 mr-1 rounded sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/posts">Posts</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed flex-col hidden gap-3 right-8 bottom-8 md:flex"><button aria-label="Scroll To Top" type="button" style="opacity:0" class="p-2 text-gray-500 transition-all bg-gray-200 rounded-full dark:text-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-300"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2021-09-02T00:00:00.000Z">Thursday, September 2, 2021</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Spring Cloud Gateway Keycloak OAuth2 OIDC Integration</h1><div class="mt-6"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzQ0IiBoZWlnaHQ9IjQwNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Spring Cloud Gateway Keycloak OAuth2 OIDC Integration" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="object-cover object-center lg:h-48 md:h-36" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Spring Cloud Gateway Keycloak OAuth2 OIDC Integration" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg?imwidth=750 1x, static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="object-cover object-center lg:h-48 md:h-36" loading="lazy"/></noscript></span></div><div class="text-primary-500 hover:text-primary-600 text-md dark:hover:text-primary-400"><div></div></div><div class="mt-2 text-gray-500 dark:text-gray-400">9 min read</div></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzgiIGhlaWdodD0iMzgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="w-10 h-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" srcSet="static/images/avatar-small.jpg?imwidth=48 1x, static/images/avatar-small.jpg?imwidth=96 2x" src="static/images/avatar-small.jpg?imwidth=96" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="w-10 h-10 rounded-full" loading="lazy"/></noscript></span><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Amrut Prabhu</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/amrutprabhu42" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@amrutprabhu42</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose text-md dark:prose-dark max-w-none"><p>In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC).</p>
<h1 id="introduction"><a href="#introduction" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Introduction</h1>
<p><a target="_blank" rel="noopener noreferrer" href="https://www.keycloak.org/">Keycloak</a> is an open-source application, which provides identity and access management. It is sponsored by Redhat, whose commercial product is <a target="_blank" rel="noopener noreferrer" href="https://access.redhat.com/products/red-hat-single-sign-on">Red Hat Single Sign-On (RH-SSO)</a> based on Keycloak.</p>
<p>Keycloak supports various features out of the box like user registration, social media logins, 2-factor authentication, LDAP integration, etc. Apart from its various integration, it also provides some easy ways to customize user login UIs, forgot password option, email login option, etc with just a click of a button. You can read more about this in their documentation <a target="_blank" rel="noopener noreferrer" href="https://www.keycloak.org/docs/latest/server_admin/">here</a></p>
<h1 id="understanding-keycloak-concepts"><a href="#understanding-keycloak-concepts" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Understanding Keycloak Concepts</h1>
<p>Now to understand Keycloak, we need to know some key concepts. Let’s have a look at that.</p>
<p>When you log in for the first time you would land up in a <code>master</code> realm.</p>
<p>What is a realm?</p>
<p>A realm is a holder of users and applications belonging to a single identity and access management. You can create multiple realms to handle multiple identities and access management. These custom reals are managed by the master real which is the admin realm for Keycloak.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAzIiBoZWlnaHQ9IjQxOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Keycloak realms" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Keycloak realms" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/keycloack-realms.png?imwidth=1080 1x, static/images/2021/spring-cloud-gateway-with-keycloak/keycloack-realms.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/keycloack-realms.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>The applications in one realm cannot access users of another realm. Here we refer to the applications as the clients who want to access some user details.</p>
<p>With this, let&#x27;s create a custom realm to handle our users.</p>
<h1 id="setting-up-keycloak"><a href="#setting-up-keycloak" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Setting up Keycloak</h1>
<p>To start Keycloak, you can start it as a standalone application by downloading the binary or you can use the <a target="_blank" rel="noopener noreferrer" href="https://www.keycloak.org/getting-started/getting-started-docker">Keycloak docker image</a>. Today we will be using the docker image to start the application. I have created a simple Keycloak docker-compose file to start Keycloak and expose its port at 8080</p>
<div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#x27;3.1&#x27;</span>
</span><span class="code-line"><span class="token key atrule">services</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token key atrule">keycloak</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/keycloak/keycloak<span class="token punctuation">:</span>15.0.1
</span><span class="code-line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token string">&#x27;8080:8080&#x27;</span>
</span><span class="code-line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> KEYCLOAK_USER=admin
</span><span class="code-line">      <span class="token punctuation">-</span> KEYCLOAK_PASSWORD=admin
</span></code></pre></div>
<p>Now, you can start Keycloak using <code>docker-compose up</code>.</p>
<p>Next, open the page at <a target="_blank" rel="noopener noreferrer" href="http://localhost:8080">http://localhost:8080</a> click on “Administration Console” and log in using “admin” as the user and password(as set in the environment variables above). Once you log in, you are already in the master realm.</p>
<p>Let’s create a new realm. Click on the master realm on the left side and then click add realm as shown in the picture.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTg3IiBoZWlnaHQ9IjQyNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Adding realm" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Adding realm" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/add-realm.png?imwidth=1080 1x, static/images/2021/spring-cloud-gateway-with-keycloak/add-realm.png?imwidth=2048 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/add-realm.png?imwidth=2048" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Now, Give it a name, I have given it as “My-Realm”</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEzNSIgaGVpZ2h0PSI1MDYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img alt="Example readlm" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Example readlm" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/my-realm.png?imwidth=1200 1x, static/images/2021/spring-cloud-gateway-with-keycloak/my-realm.png?imwidth=3840 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/my-realm.png?imwidth=3840" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Now, we would be using all the default settings here.</p>
<p>Next, let&#x27;s create a client in the “Clients” section. We will use this client to communicate with Keycloak from our Spring Cloud Gateway application.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzY2IiBoZWlnaHQ9IjM2MyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Realm Client Settings" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Realm Client Settings" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/create-client.png?imwidth=828 1x, static/images/2021/spring-cloud-gateway-with-keycloak/create-client.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/create-client.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Here we give it a client id “spring-gateway-client” and keep the client protocol as “OpenID-connect” and click save.</p>
<p>Next, we will keep the “Standard Flow Enabled” option ON which allows us to use the OAuth2 mechanism. Also, we will set the “Access Type” to “confidential”, set a “Valid redirect URI” to “<a target="_blank" rel="noopener noreferrer" href="http://localhost:9090/login/oauth2/code/keycloak%E2%80%9D">http://localhost:9090/login/oauth2/code/keycloak”</a> and can leave the rest of the default settings and save this configuration. The redirect URI refers to our Spring Cloud Gateway application, which will run at 9090.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjI3IiBoZWlnaHQ9IjgzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Realm Client Configuration" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Realm Client Configuration" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/client-config.png?imwidth=640 1x, static/images/2021/spring-cloud-gateway-with-keycloak/client-config.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/client-config.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Once you, hit save, you will get a new tab called “Credentials”. Go to the credentials section and note down the secret value. We would use this value to register this client in our application.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjUwIiBoZWlnaHQ9IjE2OSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Realm Client Credentials" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Realm Client Credentials" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/client-secret.png?imwidth=750 1x, static/images/2021/spring-cloud-gateway-with-keycloak/client-secret.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/client-secret.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Next, Let&#x27;s create a user with the username and password as “test”.</p>
<p>To do that, go to the “Users” section and click on “Add User”. Here I set the user name as “test”, first name as “Your name” and Lastname as “Last name”. Then on clicking save, we get an id generated for the User as seen in the image below. We will fetch this Id in our application after authenticating with Keycloak using OpenId Connect.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTIwIiBoZWlnaHQ9IjY3MyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Keycloak User" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Keycloak User" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/new-user.png?imwidth=1080 1x, static/images/2021/spring-cloud-gateway-with-keycloak/new-user.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/new-user.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Next, Click on the “Credentials” tabs and set a password as “test” with the “temporary” option turned off.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzU5IiBoZWlnaHQ9IjQ4OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Keycloak User credentials" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Keycloak User credentials" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/add-user-password.png?imwidth=828 1x, static/images/2021/spring-cloud-gateway-with-keycloak/add-user-password.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/add-user-password.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>That&#x27;s it. We have just created a realm with a client and a user. This is the most minimalistic configuration we have done that is enough to start integrating Keycloak with our application.</p>
<p>With this, let’s create our Spring Cloud Gateway application to integrate the Keycloak client that we just created.</p>
<h1 id="creating-an-application-with-spring-cloud-gateway"><a href="#creating-an-application-with-spring-cloud-gateway" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Creating an Application with Spring Cloud Gateway</h1>
<p>Let’s go to <a target="_blank" rel="noopener noreferrer" href="https://start.spring.io">https://start.spring.io</a> and create an application with the following dependencies.</p>
<ul>
<li>Gateway</li>
<li>OAuth2 Client</li>
</ul>
<p>Once you generate and download the application, we will create a simple RestController as follows:-</p>
<div class="relative"><pre><code class="language-java code-highlight"><span class="code-line"><span class="token annotation punctuation">@RestController</span>
</span><span class="code-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">Principal</span> principal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">return</span> principal<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>Here we are returning the name (Id of the Keycloak user) from the principal Object which is created by spring security once the user logs in.</p>
<p>Now, let&#x27;s protect this endpoint with a security configuration.</p>
<div class="relative"><pre><code class="language-java code-highlight"><span class="code-line"><span class="token annotation punctuation">@Configuration</span>
</span><span class="code-line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">{</span>
</span><span class="code-line">
</span><span class="code-line">   <span class="token annotation punctuation">@Bean</span>
</span><span class="code-line">   <span class="token keyword">public</span> <span class="token class-name">SecurityWebFilterChain</span> springSecurityFilterChain <span class="token punctuation">(</span> <span class="token class-name">ServerHttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">
</span><span class="code-line">        http
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">authorizeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">anyExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">         <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">oauth2Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// to redirect to oauth2 login page.</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">   <span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>Here, we set that, any request that comes in must be authenticated, and in case of a not logged-in user, it should use the OAuth2 login page.</p>
<p>Next, We set the properties to register the Oauth2 Keycloak client in our application.</p>
<h2 id="setting-application-property-values"><a href="#setting-application-property-values" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Setting Application Property values</h2>
<p>This contains two parts. Setting the provider properties and registering the client information properties.</p>
<ul>
<li>Provider’s properties — The provider of the OAuth2 mechanism i.e the realm.</li>
<li>Client properties — These are the properties of the Keycloak client to communicate with the realm.</li>
</ul>
<p><strong>Setting Provider Properties</strong></p>
<p>To set the provider, we need the issuer-URI. For this, you need to go back to your realm setting section and under the “General” tab, you have endpoints. Click on the “OpenId Endpoint Configuration” link and you should get a JSON, containing all the required information. E.g, for the realm we just created, here is a small snippet of the output.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyMSIgaGVpZ2h0PSI0OTMiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img alt="OpenID Connect configuration endpoint" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="OpenID Connect configuration endpoint" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/openid-endpoint-configuration.png?imwidth=1080 1x, static/images/2021/spring-cloud-gateway-with-keycloak/openid-endpoint-configuration.png?imwidth=2048 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/openid-endpoint-configuration.png?imwidth=2048" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>You then set the issuer URI for a provider name called “my-keycloak-provider” like the following.</p>
<div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token key atrule">security</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token key atrule">client</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
</span><span class="code-line">          <span class="token key atrule">my-keycloak-provider</span><span class="token punctuation">:</span>
</span><span class="code-line">            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/auth/realms/My<span class="token punctuation">-</span>Realm
</span></code></pre></div>
<p><strong>Note</strong>: The provider name can be a custom value, but you need to use this exact name while using it in the client registration properties.</p>
<p><strong>Setting Client Registration Properties</strong></p>
<p>Next, we will set the client registration properties under the registration name “keycloak-spring-gateway-client”.</p>
<div class="relative"><pre><code class="language-yaml code-highlight"><span class="code-line"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token key atrule">security</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token key atrule">client</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
</span><span class="code-line">          <span class="token key atrule">my-keycloak-provider</span><span class="token punctuation">:</span>
</span><span class="code-line">            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/auth/realms/My<span class="token punctuation">-</span>Realm
</span><span class="code-line">  <span class="token key atrule">registration</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token key atrule">keycloak-spring-gateway-client</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token key atrule">provider</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>keycloak<span class="token punctuation">-</span>provider
</span><span class="code-line">      <span class="token key atrule">client-id</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>client
</span><span class="code-line">      <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> fc36fd82<span class="token punctuation">-</span>7042<span class="token punctuation">-</span>4287<span class="token punctuation">-</span>aef0<span class="token punctuation">-</span>e9f8603abd02
</span><span class="code-line">      <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
</span><span class="code-line">      <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> <span class="token string">&#x27;{baseUrl}/login/oauth2/code/keycloak&#x27;</span>
</span><span class="code-line"><span class="token key atrule">server</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
</span></code></pre></div>
<p><strong>Note</strong>: The client registration name can be any custom name. It is used to just identify the client in your application.</p>
<p>Here, we set the client Id we created in Keycloak and the client secret from the client’s “credentials” tab in Keycloak. We also set the provider name, from the properties before, and the redirect URI which we had registered while creating the client in the Keycloak. Also, Since we will be using the authorization code grant type for the OAuth2 flow, we set the authorization grant type to “authorization_code”.</p>
<p>With all the configuration done, Let’s start the application.</p>
<h2 id="starting-the-application"><a href="#starting-the-application" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Starting the application</h2>
<p>Since we set <code>server.port=9090</code>, the application starts at 9090. When we open <a target="_blank" rel="noopener noreferrer" href="http://localhost:9090">http://localhost:9090</a> on the web browser, It immediately redirects to the login page from Keycloak as we are querying the root resource <code>/</code>.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTI0IiBoZWlnaHQ9IjU4OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="User Login" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="User Login" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/user-login-page.png?imwidth=1080 1x, static/images/2021/spring-cloud-gateway-with-keycloak/user-login-page.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/user-login-page.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>Here, enter the username and password “test” to log in. Since the authentication is now complete, The principal object is filled with the user details, and the user Id of the “test” user from Keycloak is returned.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjU5IiBoZWlnaHQ9IjE0NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="application output" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="application output" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/user-id.png?imwidth=750 1x, static/images/2021/spring-cloud-gateway-with-keycloak/user-id.png?imwidth=1920 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/user-id.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>This is the same Id that was generated by Keycloak when we created the user.</p>
<h1 id="understanding-the-oauth2-open-id-connect-flow"><a href="#understanding-the-oauth2-open-id-connect-flow" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Understanding the OAuth2 Open ID Connect Flow</h1>
<p>In the diagram below, I have summarised the flow of how the OAuth2 Connect ID flow works. It starts off with the user requesting a resource, then authenticates itself and gets a response once he is identified.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTY1NSIgaGVpZ2h0PSIxMzk0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIvPg=="/></span><img alt="Oauth2 Authorization Flow with Keycloak" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Oauth2 Authorization Flow with Keycloak" srcSet="static/images/2021/spring-cloud-gateway-with-keycloak/oauth2-oidc.png?imwidth=1920 1x, static/images/2021/spring-cloud-gateway-with-keycloak/oauth2-oidc.png?imwidth=3840 2x" src="static/images/2021/spring-cloud-gateway-with-keycloak/oauth2-oidc.png?imwidth=3840" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>The OAuth2 flow is up to the request to get the access token. Once you get the access token, the application makes a request to get the user details. This part belongs to OpenId Connect to get the identity of the user.</p>
<h1 id="conclusion"><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h1>
<p>So with this, we were able to integrate the Spring Cloud Gateway with Keycloak and set up OAuth2 OpenId Connect to authenticate the user.</p>
<p>I have uploaded the code integrating Keycloak on <a target="_blank" rel="noopener noreferrer" href="https://github.com/amrutprabhu/keycloak-spring-cloud-gateway-and-resource-server">GitHub</a>.</p>
<p>Wait... There is more to come up.</p>
<p>Next, we will integrate a backend service to this API Gateway as an OAuth2 resource server and check the user for authorization. This will be in the next article I am currently working on.</p>
<p>So, subscribe to my newsletter and also follow me on <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/amrutprabhu42">Twitter</a> to know once it’s published.</p>
<p>Enjoy!!</p></div><hr/></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/spring-boot">Spring Boot</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/java">Java</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/gateway">Gateway</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/keycloak">Keycloak</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/oauth2">Oauth2</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/openid-connect">OpenId Connect</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/distributed-tracing-with-spring-cloud-sleuth">Distributed Tracing with Spring Cloud Sleuth And Zipkin</a></div></div><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/spring-cloud-gateway-keycloak-rbac-resource-server">Spring Cloud Gateway — Resource Server with Keycloak RBAC</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/">← Back to the articles</a></div></footer></div></div></article></div></main><div class="ml-form-embed" data-account="3117349:p5v1c3m1v8" data-form="4015126:i6h8m5"></div><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:contact@refactorfirst.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/amrutprabhu"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/amrut-prabhu-722baa65/"><span class="sr-only">linkedin</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/amrutprabhu42"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Amrut Prabhu</div><div> • </div><div>© 2022</div><div> • </div><a href="/">RefactorFirst</a><div> • </div><a href="/privacy">Privacy Policy</a></div><br/></div></footer></div></div><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div id="cookie-notice" class="consent_consentname__aF_O7"><br/><br/><p>By clicking “I Accept”, you agree to the storing of cookies on your device to enhance site navigation and analyze site usage</p><br/><br/><div><a id="cookie-notice-accept" class="consent_greenButton__K0FRN">I Accept</a><a href="/privacy">Privacy Policy</a></div><br/><br/><br/></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var h=Object.create;var c=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var l=a=\u003ec(a,\"__esModule\",{value:!0});var k=(a,t)=\u003e()=\u003e(t||a((t={exports:{}}).exports,t),t.exports),g=(a,t)=\u003e{l(a);for(var s in t)c(a,s,{get:t[s],enumerable:!0})},N=(a,t,s)=\u003e{if(t\u0026\u0026typeof t==\"object\"||typeof t==\"function\")for(let n of p(t))!m.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026c(a,n,{get:()=\u003et[n],enumerable:!(s=d(t,n))||s.enumerable});return a},y=a=\u003eN(l(c(a!=null?h(u(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=k((O,o)=\u003e{o.exports=_jsx_runtime});var I={};g(I,{default:()=\u003ev,frontmatter:()=\u003ew});var e=y(r()),w={title:\"Spring Cloud Gateway Keycloak OAuth2 OIDC Integration\",author:\"Amrut Prabhu\",categories:\"\",tags:[\"Spring Boot\",\"Java\",\"Gateway\",\"Keycloak\",\"Oauth2\",\"OpenId Connect\"],\"photo-credits\":\"\",\"applaud-link\":\"2021/spring-gateway-oauth2-keycloak.json\",date:\"2021-09-02\",draft:!1,summary:\"In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC).\",imageUrl:\"/static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg\",actualUrl:\"auto-generated\",customUrl:\"auto-generated\"};function f(a={}){let{wrapper:t}=a.components||{};return t?(0,e.jsx)(t,Object.assign({},a,{children:(0,e.jsx)(s,{})})):s();function s(){let n=Object.assign({p:\"p\",h1:\"h1\",a:\"a\",span:\"span\",code:\"code\",div:\"div\",pre:\"pre\",ul:\"ul\",li:\"li\",h2:\"h2\",strong:\"strong\"},a.components),{Image:i}=n;return i||b(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC).\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"introduction\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#introduction\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Introduction\"]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.a,{href:\"https://www.keycloak.org/\",children:\"Keycloak\"}),\" is an open-source application, which provides identity and access management. It is sponsored by Redhat, whose commercial product is \",(0,e.jsx)(n.a,{href:\"https://access.redhat.com/products/red-hat-single-sign-on\",children:\"Red Hat Single Sign-On (RH-SSO)\"}),\" based on Keycloak.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Keycloak supports various features out of the box like user registration, social media logins, 2-factor authentication, LDAP integration, etc. Apart from its various integration, it also provides some easy ways to customize user login UIs, forgot password option, email login option, etc with just a click of a button. You can read more about this in their documentation \",(0,e.jsx)(n.a,{href:\"https://www.keycloak.org/docs/latest/server_admin/\",children:\"here\"})]}),`\n`,(0,e.jsxs)(n.h1,{id:\"understanding-keycloak-concepts\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#understanding-keycloak-concepts\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Understanding Keycloak Concepts\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now to understand Keycloak, we need to know some key concepts. Let\\u2019s have a look at that.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"When you log in for the first time you would land up in a \",(0,e.jsx)(n.code,{children:\"master\"}),\" realm.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"What is a realm?\"}),`\n`,(0,e.jsx)(n.p,{children:\"A realm is a holder of users and applications belonging to a single identity and access management. You can create multiple realms to handle multiple identities and access management. These custom reals are managed by the master real which is the admin realm for Keycloak.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Keycloak realms\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/keycloack-realms.png\",width:\"903\",height:\"418\"})}),`\n`,(0,e.jsx)(n.p,{children:\"The applications in one realm cannot access users of another realm. Here we refer to the applications as the clients who want to access some user details.\"}),`\n`,(0,e.jsx)(n.p,{children:\"With this, let's create a custom realm to handle our users.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"setting-up-keycloak\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#setting-up-keycloak\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Setting up Keycloak\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"To start Keycloak, you can start it as a standalone application by downloading the binary or you can use the \",(0,e.jsx)(n.a,{href:\"https://www.keycloak.org/getting-started/getting-started-docker\",children:\"Keycloak docker image\"}),\". Today we will be using the docker image to start the application. I have created a simple Keycloak docker-compose file to start Keycloak and expose its port at 8080\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"version\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'3.1'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"services\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"keycloak\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"image\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" quay.io/keycloak/keycloak\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`15.0.1\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"ports\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'8080:8080'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"environment\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` KEYCLOAK_USER=admin\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` KEYCLOAK_PASSWORD=admin\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Now, you can start Keycloak using \",(0,e.jsx)(n.code,{children:\"docker-compose up\"}),\".\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Next, open the page at \",(0,e.jsx)(n.a,{href:\"http://localhost:8080\",children:\"http://localhost:8080\"}),\" click on \\u201CAdministration Console\\u201D and log in using \\u201Cadmin\\u201D as the user and password(as set in the environment variables above). Once you log in, you are already in the master realm.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s create a new realm. Click on the master realm on the left side and then click add realm as shown in the picture.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Adding realm\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/add-realm.png\",width:\"987\",height:\"425\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Now, Give it a name, I have given it as \\u201CMy-Realm\\u201D\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Example readlm\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/my-realm.png\",width:\"1135\",height:\"506\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Now, we would be using all the default settings here.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Next, let's create a client in the \\u201CClients\\u201D section. We will use this client to communicate with Keycloak from our Spring Cloud Gateway application.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Realm Client Settings\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/create-client.png\",width:\"766\",height:\"363\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Here we give it a client id \\u201Cspring-gateway-client\\u201D and keep the client protocol as \\u201COpenID-connect\\u201D and click save.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"Next, we will keep the \\u201CStandard Flow Enabled\\u201D option ON which allows us to use the OAuth2 mechanism. Also, we will set the \\u201CAccess Type\\u201D to \\u201Cconfidential\\u201D, set a \\u201CValid redirect URI\\u201D to \\u201C\",(0,e.jsx)(n.a,{href:\"http://localhost:9090/login/oauth2/code/keycloak%E2%80%9D\",children:\"http://localhost:9090/login/oauth2/code/keycloak\\u201D\"}),\" and can leave the rest of the default settings and save this configuration. The redirect URI refers to our Spring Cloud Gateway application, which will run at 9090.\"]}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Realm Client Configuration\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/client-config.png\",width:\"627\",height:\"832\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Once you, hit save, you will get a new tab called \\u201CCredentials\\u201D. Go to the credentials section and note down the secret value. We would use this value to register this client in our application.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Realm Client Credentials\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/client-secret.png\",width:\"650\",height:\"169\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Next, Let's create a user with the username and password as \\u201Ctest\\u201D.\"}),`\n`,(0,e.jsx)(n.p,{children:\"To do that, go to the \\u201CUsers\\u201D section and click on \\u201CAdd User\\u201D. Here I set the user name as \\u201Ctest\\u201D, first name as \\u201CYour name\\u201D and Lastname as \\u201CLast name\\u201D. Then on clicking save, we get an id generated for the User as seen in the image below. We will fetch this Id in our application after authenticating with Keycloak using OpenId Connect.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Keycloak User\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/new-user.png\",width:\"920\",height:\"673\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Next, Click on the \\u201CCredentials\\u201D tabs and set a password as \\u201Ctest\\u201D with the \\u201Ctemporary\\u201D option turned off.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Keycloak User credentials\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/add-user-password.png\",width:\"759\",height:\"488\"})}),`\n`,(0,e.jsx)(n.p,{children:\"That's it. We have just created a realm with a client and a user. This is the most minimalistic configuration we have done that is enough to start integrating Keycloak with our application.\"}),`\n`,(0,e.jsx)(n.p,{children:\"With this, let\\u2019s create our Spring Cloud Gateway application to integrate the Keycloak client that we just created.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"creating-an-application-with-spring-cloud-gateway\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#creating-an-application-with-spring-cloud-gateway\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Creating an Application with Spring Cloud Gateway\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Let\\u2019s go to \",(0,e.jsx)(n.a,{href:\"https://start.spring.io\",children:\"https://start.spring.io\"}),\" and create an application with the following dependencies.\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Gateway\"}),`\n`,(0,e.jsx)(n.li,{children:\"OAuth2 Client\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"Once you generate and download the application, we will create a simple RestController as follows:-\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@RestController\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Controller\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@GetMapping\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"/\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"String\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"index\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Principal\"}),\" principal\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" principal\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getName\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Here we are returning the name (Id of the Keycloak user) from the principal Object which is created by spring security once the user logs in.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Now, let's protect this endpoint with a security configuration.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@Configuration\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"SecurityConfig\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@Bean\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"SecurityWebFilterChain\"}),\" springSecurityFilterChain \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ServerHttpSecurity\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`        http\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"authorizeExchange\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"anyExchange\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"authenticated\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"         \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"and\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"oauth2Login\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// to redirect to oauth2 login page.\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"build\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Here, we set that, any request that comes in must be authenticated, and in case of a not logged-in user, it should use the OAuth2 login page.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Next, We set the properties to register the Oauth2 Keycloak client in our application.\"}),`\n`,(0,e.jsxs)(n.h2,{id:\"setting-application-property-values\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#setting-application-property-values\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Setting Application Property values\"]}),`\n`,(0,e.jsx)(n.p,{children:\"This contains two parts. Setting the provider properties and registering the client information properties.\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Provider\\u2019s properties\\u200A\\u2014\\u200AThe provider of the OAuth2 mechanism i.e the realm.\"}),`\n`,(0,e.jsx)(n.li,{children:\"Client properties\\u200A\\u2014\\u200AThese are the properties of the Keycloak client to communicate with the realm.\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"Setting Provider Properties\"})}),`\n`,(0,e.jsx)(n.p,{children:\"To set the provider, we need the issuer-URI. For this, you need to go back to your realm setting section and under the \\u201CGeneral\\u201D tab, you have endpoints. Click on the \\u201COpenId Endpoint Configuration\\u201D link and you should get a JSON, containing all the required information. E.g, for the realm we just created, here is a small snippet of the output.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"OpenID Connect configuration endpoint\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/openid-endpoint-configuration.png\",width:\"1021\",height:\"493\"})}),`\n`,(0,e.jsx)(n.p,{children:\"You then set the issuer URI for a provider name called \\u201Cmy-keycloak-provider\\u201D like the following.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"spring\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"security\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"oauth2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"client\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"my-keycloak-provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"issuer-uri\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"//localhost\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"8080/auth/realms/My\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`Realm\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"Note\"}),\": The provider name can be a custom value, but you need to use this exact name while using it in the client registration properties.\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"Setting Client Registration Properties\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Next, we will set the client registration properties under the registration name \\u201Ckeycloak-spring-gateway-client\\u201D.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"spring\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"security\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"oauth2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"client\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"          \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"my-keycloak-provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"issuer-uri\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"//localhost\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"8080/auth/realms/My\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`Realm\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"registration\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"keycloak-spring-gateway-client\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"provider\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" my\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"keycloak\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`provider\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"client-id\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" spring\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"gateway\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`client\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"client-secret\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" fc36fd82\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"7042\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"4287\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\"aef0\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),`e9f8603abd02\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"authorization-grant-type\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` authorization_code\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"redirect-uri\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'{baseUrl}/login/oauth2/code/keycloak'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"server\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"port\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"9090\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"Note\"}),\": The client registration name can be any custom name. It is used to just identify the client in your application.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Here, we set the client Id we created in Keycloak and the client secret from the client\\u2019s \\u201Ccredentials\\u201D tab in Keycloak. We also set the provider name, from the properties before, and the redirect URI which we had registered while creating the client in the Keycloak. Also, Since we will be using the authorization code grant type for the OAuth2 flow, we set the authorization grant type to \\u201Cauthorization_code\\u201D.\"}),`\n`,(0,e.jsx)(n.p,{children:\"With all the configuration done, Let\\u2019s start the application.\"}),`\n`,(0,e.jsxs)(n.h2,{id:\"starting-the-application\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#starting-the-application\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Starting the application\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Since we set \",(0,e.jsx)(n.code,{children:\"server.port=9090\"}),\", the application starts at 9090. When we open \",(0,e.jsx)(n.a,{href:\"http://localhost:9090\",children:\"http://localhost:9090\"}),\" on the web browser, It immediately redirects to the login page from Keycloak as we are querying the root resource \",(0,e.jsx)(n.code,{children:\"/\"}),\".\"]}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"User Login\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/user-login-page.png\",width:\"924\",height:\"588\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Here, enter the username and password \\u201Ctest\\u201D to log in. Since the authentication is now complete, The principal object is filled with the user details, and the user Id of the \\u201Ctest\\u201D user from Keycloak is returned.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"application output\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/user-id.png\",width:\"659\",height:\"146\"})}),`\n`,(0,e.jsx)(n.p,{children:\"This is the same Id that was generated by Keycloak when we created the user.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"understanding-the-oauth2-open-id-connect-flow\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#understanding-the-oauth2-open-id-connect-flow\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Understanding the OAuth2 Open ID Connect Flow\"]}),`\n`,(0,e.jsx)(n.p,{children:\"In the diagram below, I have summarised the flow of how the OAuth2 Connect ID flow works. It starts off with the user requesting a resource, then authenticates itself and gets a response once he is identified.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Oauth2 Authorization Flow with Keycloak\",src:\"/static/images/2021/spring-cloud-gateway-with-keycloak/oauth2-oidc.png\",width:\"1655\",height:\"1394\"})}),`\n`,(0,e.jsx)(n.p,{children:\"The OAuth2 flow is up to the request to get the access token. Once you get the access token, the application makes a request to get the user details. This part belongs to OpenId Connect to get the identity of the user.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#conclusion\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),`\n`,(0,e.jsx)(n.p,{children:\"So with this, we were able to integrate the Spring Cloud Gateway with Keycloak and set up OAuth2 OpenId Connect to authenticate the user.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"I have uploaded the code integrating Keycloak on \",(0,e.jsx)(n.a,{href:\"https://github.com/amrutprabhu/keycloak-spring-cloud-gateway-and-resource-server\",children:\"GitHub\"}),\".\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Wait... There is more to come up.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Next, we will integrate a backend service to this API Gateway as an OAuth2 resource server and check the user for authorization. This will be in the next article I am currently working on.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"So, subscribe to my newsletter and also follow me on \",(0,e.jsx)(n.a,{href:\"https://twitter.com/amrutprabhu42\",children:\"Twitter\"}),\" to know once it\\u2019s published.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Enjoy!!\"})]})}}var v=f;function b(a,t){throw new Error(\"Expected \"+(t?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return I;})();\n;return Component;","toc":[{"value":"Introduction","url":"#introduction","depth":1},{"value":"Understanding Keycloak Concepts","url":"#understanding-keycloak-concepts","depth":1},{"value":"Setting up Keycloak","url":"#setting-up-keycloak","depth":1},{"value":"Creating an Application with Spring Cloud Gateway","url":"#creating-an-application-with-spring-cloud-gateway","depth":1},{"value":"Setting Application Property values","url":"#setting-application-property-values","depth":2},{"value":"Starting the application","url":"#starting-the-application","depth":2},{"value":"Understanding the OAuth2 Open ID Connect Flow","url":"#understanding-the-oauth2-open-id-connect-flow","depth":1},{"value":"Conclusion","url":"#conclusion","depth":1}],"frontMatter":{"readingTime":{"text":"9 min read","minutes":8.765,"time":525900,"words":1753},"slug":"2021/spring-cloud-gateway-keycloak-oauth2-openid-connect","fileName":"2021/spring-cloud-gateway-keycloak-oauth2-openid-connect.md","title":"Spring Cloud Gateway Keycloak OAuth2 OIDC Integration","author":"Amrut Prabhu","categories":"","tags":["Spring Boot","Java","Gateway","Keycloak","Oauth2","OpenId Connect"],"photo-credits":"","applaud-link":"2021/spring-gateway-oauth2-keycloak.json","date":"2021-09-02T00:00:00.000Z","draft":false,"summary":"In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC).","imageUrl":"/static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg","actualUrl":"2021/spring-cloud-gateway-keycloak-oauth2-openid-connect","customUrl":"spring-cloud-gateway-keycloak-oauth2-openid-connect"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.875,"time":52500,"words":175},"slug":["default"],"fileName":"default.md","name":"Amrut Prabhu","avatar":"/static/images/avatar-small.jpg","avatarBig":"/static/images/avatar-big.jpg","occupation":"Staff Engineer","company":"Personal","email":"contact@refactorfirst.com","twitter":"https://twitter.com/amrutprabhu42","linkedin":"https://www.linkedin.com/in/amrut-prabhu-722baa65/","github":"https://github.com/amrutprabhu","customUrl":"default","actualUrl":"default","date":null}],"prev":{"title":"Distributed Tracing with Spring Cloud Sleuth And Zipkin","author":"Amrut Prabhu","tags":["Spring Boot","Java","Distributed Tracing","Zipkin"],"photo-credits":"https://unsplash.com/photos/d9ILr-dbEdg","applaud-link":"2021/distributed-tracing-with-spring-zipkin.json","date":"2021-08-19T00:00:00.000Z","draft":false,"summary":"We would learn how we can implement distributed tracing in a Spring Boot Application and understand the key concepts of distributed tracing","imageUrl":"/static/images/2021/distributed-tracing-with-zipkin/cover.jpg","actualUrl":"2021/distributed-tracing-with-spring-cloud-sleuth","customUrl":"distributed-tracing-with-spring-cloud-sleuth","slug":"distributed-tracing-with-spring-cloud-sleuth"},"next":{"title":"Spring Cloud Gateway — Resource Server with Keycloak RBAC","author":"Amrut Prabhu","categories":"","tags":["Spring Boot","Java","Gateway","Keycloak","Oauth2","OpenId Connect","Resource Server"],"image":"2021/spring-cloud-gateway-with-resource-server/cover.jpg","photo-credits":null,"applaud-link":"2021/spring-gateway-keycloak-resource-server.json","date":"2021-09-16T00:00:00.000Z","draft":false,"summary":"In this article, we will be exploring how we can integrate a resource server with an API gateway that is integrated with Keycloak and enable role-based access control (RBAC)","imageUrl":"/static/images/2021/spring-cloud-gateway-with-resource-server/cover.jpg","actualUrl":"2021/spring-cloud-gateway-keycloak-rbac-resource-server","customUrl":"spring-cloud-gateway-keycloak-rbac-resource-server","slug":"spring-cloud-gateway-keycloak-rbac-resource-server"}},"__N_SSG":true},"page":"/[slug]","query":{"slug":"spring-cloud-gateway-keycloak-oauth2-openid-connect"},"buildId":"noK4yT0ecC1tFZf8SofZV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>