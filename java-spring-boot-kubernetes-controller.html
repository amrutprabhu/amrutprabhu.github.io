<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/icon.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/icon.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');d.add('light');if("system"===e||(!e&&false)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="amrutprabhu" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18" strategy="afterInteractive" async=""></script><title>Part 2: How to Create a Spring Boot Kubernetes Controller | RefactorFirst</title><meta name="robots" content="follow, index"/><meta name="description" content=" In this article, we learn how to create a Spring Boot based Kubernetes Controller and explore the various components needed to create it."/><meta property="og:url" content="https://refactorfirst.com/java-spring-boot-kubernetes-controller"/><meta property="og:type" content="article"/><meta property="og:site_name" content="RefactorFirst"/><meta property="og:description" content=" In this article, we learn how to create a Spring Boot based Kubernetes Controller and explore the various components needed to create it."/><meta property="og:title" content="Part 2: How to Create a Spring Boot Kubernetes Controller"/><meta property="og:image" content="https://refactorfirst.com/static/images/2022/create-kubernetes-controller-with-spring/cover.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/amrutprabhu42"/><meta name="twitter:title" content="Part 2: How to Create a Spring Boot Kubernetes Controller"/><meta name="twitter:description" content=" In this article, we learn how to create a Spring Boot based Kubernetes Controller and explore the various components needed to create it."/><meta name="twitter:image" content="https://refactorfirst.com/static/images/2022/create-kubernetes-controller-with-spring/cover.jpg"/><meta property="article:published_time" content="2022-07-21T00:00:00.000Z"/><link rel="canonical" href="https://refactorfirst.com/java-spring-boot-kubernetes-controller"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://refactorfirst.com/2022/java-spring-boot-kubernetes-controller"
  },
  "headline": "Part 2: How to Create a Spring Boot Kubernetes Controller",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://refactorfirst.com/static/images/2022/create-kubernetes-controller-with-spring/cover.jpg"
    }
  ],
  "datePublished": "2022-07-21T00:00:00.000Z",
  "dateModified": "2022-07-21T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Amrut Prabhu"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Amrut Prabhu",
    "logo": {
      "@type": "ImageObject",
      "url": "https://refactorfirst.com/static/images/favicons/icon.png"
    }
  },
  "description": " In this article, we learn how to create a Spring Boot based Kubernetes Controller and explore the various components needed to create it."
}</script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/css/34df01f9942f8b1a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/34df01f9942f8b1a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-6c22ee2e5100b77f.js" defer=""></script><script src="/_next/static/chunks/main-a8532ea7c2505ecc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-115c3eb9acb4de97.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/207-4f91422181f853c0.js" defer=""></script><script src="/_next/static/chunks/102-1bd6bc28ac3a6469.js" defer=""></script><script src="/_next/static/chunks/883-f7b9c09cd6586f5d.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-da416b81bf0ecd48.js" defer=""></script><script src="/_next/static/d-J57GRCfk9HGzn9Oxtu8/_buildManifest.js" defer=""></script><script src="/_next/static/d-J57GRCfk9HGzn9Oxtu8/_ssgManifest.js" defer=""></script><script src="/_next/static/d-J57GRCfk9HGzn9Oxtu8/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-6xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="RefactorFirst" href="/"><div class="flex items-center justify-between"><div class="mr-3"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img srcSet="/static/favicons/icon.png?imwidth=64 1x, /static/favicons/icon.png?imwidth=128 2x" src="/static/favicons/icon.png?imwidth=128" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="h-6 text-2xl font-semibold sm:block">RefactorFirst</div></div></a></div><div class="mt-6"></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/posts">Posts</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="w-8 h-8 p-1 ml-1 mr-1 rounded sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/posts">Posts</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-6xl xl:px-0"><div class="fixed flex-col hidden gap-3 right-8 bottom-8 md:flex"><button aria-label="Scroll To Top" type="button" style="opacity:0" class="p-2 text-gray-500 transition-all bg-gray-200 rounded-full dark:text-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 hover:bg-gray-300"><svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-07-21T00:00:00.000Z">Thursday, July 21, 2022</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Part 2: How to Create a Spring Boot Kubernetes Controller</h1><div class="mt-6"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzQ0IiBoZWlnaHQ9IjQwNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiLz4="/></span><img alt="Part 2: How to Create a Spring Boot Kubernetes Controller" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="object-cover object-center lg:h-48 md:h-36" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Part 2: How to Create a Spring Boot Kubernetes Controller" srcSet="static/images/2022/create-kubernetes-controller-with-spring/cover.jpg?imwidth=750 1x, static/images/2022/create-kubernetes-controller-with-spring/cover.jpg?imwidth=1920 2x" src="static/images/2022/create-kubernetes-controller-with-spring/cover.jpg?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="object-cover object-center lg:h-48 md:h-36" loading="lazy"/></noscript></span></div><div class="text-primary-500 hover:text-primary-600 text-md dark:hover:text-primary-400"><div></div></div><div class="mt-2 text-gray-500 dark:text-gray-400">9 min read</div></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzgiIGhlaWdodD0iMzgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="w-10 h-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" srcSet="static/images/avatar-small.jpg?imwidth=48 1x, static/images/avatar-small.jpg?imwidth=96 2x" src="static/images/avatar-small.jpg?imwidth=96" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="w-10 h-10 rounded-full" loading="lazy"/></noscript></span><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Amrut Prabhu</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/amrutprabhu42" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@amrutprabhu42</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose text-md dark:prose-dark max-w-none"><p>In my earlier article <a target="_blank" rel="noopener noreferrer" href="https://refactorfirst.com/create-kubernetes-custom-resource-definition-crd">here</a>, we saw how we can create a Kubernetes Custom Resource Definition (CRD) and deploy it to a Kubernetes cluster. In this article, we will look at creating a Kubernetes Controller using Spring Boot that will handle requests when a CRD instance is created, updated, or deleted.</p>
<h1 id="project-setup"><a href="#project-setup" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Project Setup</h1>
<p>Let’s go to <a target="_blank" rel="noopener noreferrer" href="https://start.spring.io">https://start.spring.io</a> and create a new project with the following dependencies.</p>
<ul>
<li>Spring Starter Web</li>
</ul>
<p>Next, you need to add the Kubernetes Java client dependency as below</p>
<div class="relative"><pre><code class="language-xml code-highlight"><span class="code-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
</span><span class="code-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.kubernetes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
</span><span class="code-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>client-java-spring-integration<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
</span><span class="code-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>16.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
</span><span class="code-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</span></code></pre></div>
<p>With this, we are ready with the setup.</p>
<h1 id="generating-java-model-classes-for-crd"><a href="#generating-java-model-classes-for-crd" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Generating Java Model Classes For CRD</h1>
<p>In order to work with the Kubernetes CRD, we created in the previous article, we would need to get Java class representations of the CRD.</p>
<p>We can use a utility that will generate the class files from a deployed CRD.</p>
<p>For this, you need to have docker running and then run the following command.</p>
<div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token shebang important">#!/usr/bin/env bash</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token assign-left variable">LOCAL_MANIFEST_FILE</span><span class="token operator">=</span>/home/amrut/projects/kubernetes-custom-resource/crd/my-crd.yaml
</span><span class="code-line"><span class="token function">mkdir</span> -p /tmp/java <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> /tmp/java
</span><span class="code-line">docker run <span class="token punctuation">\</span>
</span><span class="code-line">  --rm <span class="token punctuation">\</span>
</span><span class="code-line">  -v <span class="token string">&quot;<span class="token variable">$LOCAL_MANIFEST_FILE</span>&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;<span class="token variable">$LOCAL_MANIFEST_FILE</span>&quot;</span> <span class="token punctuation">\</span>
</span><span class="code-line">  -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
</span><span class="code-line">  -v <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
</span><span class="code-line">  -ti <span class="token punctuation">\</span>
</span><span class="code-line">  --network <span class="token function">host</span> <span class="token punctuation">\</span>
</span><span class="code-line">  ghcr.io/kubernetes-client/java/crd-model-gen:v1.0.6 <span class="token punctuation">\</span>
</span><span class="code-line">  /generate.sh <span class="token punctuation">\</span>
</span><span class="code-line">  -u <span class="token variable">$LOCAL_MANIFEST_FILE</span> <span class="token punctuation">\</span>
</span><span class="code-line">  -n prabhu.amrut.com <span class="token punctuation">\</span>
</span><span class="code-line">  -p com.amrut.prabhu <span class="token punctuation">\</span>
</span><span class="code-line">  -o <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>&quot;</span>
</span></code></pre></div>
<p>Let me explain what this command does.</p>
<p>It first creates a temp directory to store the generated classes. It then starts a <a target="_blank" rel="noopener noreferrer" href="https://refactorfirst.com/kind-kubernetes-cluster">Kind Kubernetes Cluster</a> using Docker, applies the mounted Kubernetes CRD file to the cluster, and generates the Java class files from the deployed CRD in the temp directory.</p>
<blockquote>
<p><strong>Important note</strong>: The flag -n should be the reverse order of the group name. In our case its <code>prabhu.amrut.com</code> since the group name was <code>com.amrut.prabhu</code></p>
</blockquote>
<p>You can always read about this in their documentation <a target="_blank" rel="noopener noreferrer" href="https://github.com/kubernetes-client/java/blob/master/docs/generate-model-from-third-party-resources.md#example-commands-for-local-crd-manifests">here</a>.</p>
<h1 id="understanding-the-use-case"><a href="#understanding-the-use-case" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Understanding the Use Case</h1>
<p>Before we start creating the controller, let’s understand the use case we want to achieve.</p>
<p>When we create a CRD instance, we want the controller to create a Kubernetes config map. If the CRD instance is updated, the controller updates the config map and similarly, if it is deleted, the config map is deleted.</p>
<p>With this understanding, Let’s create our Kubernetes Controller.</p>
<h1 id="creating-a-kubernetes-controller"><a href="#creating-a-kubernetes-controller" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Creating a Kubernetes Controller</h1>
<p>Now to create a controller, we need to create a few components.</p>
<ul>
<li>A reconciler: This component is used to handle requests when there is a change in the CRD instance. It will be invoked when we create, update or delete a CRD instance so that we can do something with the changes.</li>
<li>A Shared Index Informer: This is more like a cache, so the controller does not need to continuously poll the Kubernetes cluster (API server) to check if there are any new CRD instances created, updated, or deleted.</li>
<li>APIClient: It is a client used to connect to the Kubernetes Cluster (API server)</li>
<li>CRD Model: These are the model classes we generated earlier.</li>
</ul>
<p>Let’s start with creating the first component which is the shared index informer.</p>
<div class="relative"><pre><code class="language-java code-highlight"><span class="code-line"><span class="token annotation punctuation">@Bean</span>
</span><span class="code-line"><span class="token class-name">SharedIndexInformer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V1MyCrd</span><span class="token punctuation">&gt;</span></span> <span class="token function">sharedIndexInformer</span><span class="token punctuation">(</span><span class="token class-name">SharedInformerFactory</span> sharedInformerFactory<span class="token punctuation">,</span> <span class="token class-name">ApiClient</span> apiClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token class-name">GenericKubernetesApi</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V1MyCrd</span><span class="token punctuation">,</span> <span class="token class-name">V1MyCrdList</span><span class="token punctuation">&gt;</span></span> api <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericKubernetesApi</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">V1MyCrd</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
</span><span class="code-line">            <span class="token class-name">V1MyCrdList</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
</span><span class="code-line">            <span class="token string">&quot;com.amrut.prabhu&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">            <span class="token string">&quot;v1&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">            <span class="token string">&quot;my-crds&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">            apiClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token keyword">return</span> sharedInformerFactory<span class="token punctuation">.</span><span class="token function">sharedIndexInformerFor</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token class-name">V1MyCrd</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span></code></pre></div>
<p>So here, we create an index informer, which will be having a reference of an APIClient to look for any created instances of the CRD.</p>
<h2 id="understanding-the-reconciler-component"><a href="#understanding-the-reconciler-component" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Understanding the Reconciler Component</h2>
<p>Now, to understand what we should do in the reconciler, let’s see this with a small flow chart.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjgzIiBoZWlnaHQ9IjEzOTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img alt="Reconciler Flowchart" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Reconciler Flowchart" srcSet="static/images/2022/create-kubernetes-controller-with-spring/reconciler-flowchart.png?imwidth=750 1x, static/images/2022/create-kubernetes-controller-with-spring/reconciler-flowchart.png?imwidth=1920 2x" src="static/images/2022/create-kubernetes-controller-with-spring/reconciler-flowchart.png?imwidth=1920" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<p>This is the simplest algorithm.</p>
<p>As you can see in the flow chart, there are 3 variants of the incoming requests i.e Create, Update, and Delete.</p>
<p>Let’s look at them.</p>
<ul>
<li>Create Instance Request:- When we receive this request, we get a reference to the resource instance from the index informer. We can then do something like creating a config map. Now, when we create a new resource as a result of CRD instance creation, we need to set the current CRD instance as the owner of the new resource. Why? we will find out soon.</li>
<li>Update Instance Request: In this case, we get an updated reference of the CRD instance and we perform an update on our components i.e. update the previously created config map.</li>
<li>Delete Instance Request: In this case, we don&#x27;t have to do anything. As soon as we delete the CRD instance, Kubernetes automatically deletes all the resources it owns. This is why we set the ownership while creating a new resource.</li>
</ul>
<h2 id="implementing-the-reconciler-component"><a href="#implementing-the-reconciler-component" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Implementing the Reconciler Component</h2>
<p>Let’s look at the reconciler code in two parts.</p>
<div class="relative"><pre><code class="language-java code-highlight"><span class="code-line">request <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token class-name">String</span> key <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token class-name">V1MyCrd</span> resourceInstance <span class="token operator">=</span> shareIndexInformer
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">getIndexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">getByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceInstance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token class-name">V1ConfigMap</span> v1ConfigMap <span class="token operator">=</span> <span class="token function">createConfigMap</span><span class="token punctuation">(</span>resourceInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line">        <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">            coreV1Api<span class="token punctuation">.</span><span class="token function">createNamespacedConfigMap</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">                    v1ConfigMap<span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token keyword">null</span><span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span></code></pre></div>
<p>Here, when the request that comes in just contains the namespace and the name of the resource that was created. We then fetch the reference to the CRDS instance using the shared index former. If the instance was created, we would get a reference, or else it will be null indicating the instance was deleted. Once we get the reference, we then create a Kubernetes config map using the CoreAPI.</p>
<p>Let’s look at the config map creation function.</p>
<div class="relative"><pre><code class="language-java code-highlight"><span class="code-line"><span class="token keyword">private</span> <span class="token class-name">V1ConfigMap</span> <span class="token function">createConfigMap</span><span class="token punctuation">(</span><span class="token class-name">V1MyCrd</span> resourceInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">V1ConfigMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">metadata</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">V1ObjectMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">                    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;my-config-map&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">                    <span class="token punctuation">.</span><span class="token function">addOwnerReferencesItem</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">V1OwnerReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">                            <span class="token punctuation">.</span><span class="token function">apiVersion</span><span class="token punctuation">(</span>resourceInstance<span class="token punctuation">.</span><span class="token function">getApiVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">                            <span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span>resourceInstance<span class="token punctuation">.</span><span class="token function">getKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">                            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>resourceInstance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">                            <span class="token punctuation">.</span><span class="token function">uid</span><span class="token punctuation">(</span>resourceInstance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">_of_</span><span class="token punctuation">(</span><span class="token string">&quot;amrut&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;prabhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>If you see here, I create a new config map object and set the reference of the current CRD instance as the owner of the config map.</p>
<p>Now let’s look at what happens during the update.</p>
<div class="relative"><pre><code class="language-java code-highlight"><span class="code-line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token class-name">System</span><span class="token punctuation">.</span>_out_<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">409</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">            coreV1Api<span class="token punctuation">.</span><span class="token function">replaceNamespacedConfigMap</span><span class="token punctuation">(</span><span class="token string">&quot;my-config-map&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">                    request<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">                    v1ConfigMap<span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token keyword">null</span><span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">                    <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApiException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">        <span class="token punctuation">}</span>
</span><span class="code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line">    <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre></div>
<p>When we receive an update, the index informer just gives us a reference to the updated CRD instance, and we still don&#x27;t know if the incoming request is for a create or update.</p>
<p>So we proceed with a normal create approach, which fails by throwing an exception with a code 409, which means the resource is already created. We then know that the current request is an update and update the config map.</p>
<p>In the case of the delete, we don&#x27;t have to do anything. Kubernetes will automatically delete all the resources owned by our CRD instance.</p>
<p>This is the reason we need to set the CRD instance as the owner of all the resources we created while handling the CRD instance creation request.</p>
<div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkwOCIgaGVpZ2h0PSI3MDgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4xIi8+"/></span><img alt="CRD apply output" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="CRD apply output" srcSet="static/images/2022/create-kubernetes-controller-with-spring/crds-instance-apply-output.png?imwidth=1920 1x, static/images/2022/create-kubernetes-controller-with-spring/crds-instance-apply-output.png?imwidth=3840 2x" src="static/images/2022/create-kubernetes-controller-with-spring/crds-instance-apply-output.png?imwidth=3840" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div>
<h1 id="conclusion"><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h1>
<p>Today we created a Spring Boot Kubernetes controller and handled requests for our own Kubernetes CRD instance creation, update, or deletion.</p>
<p>This article is largely inspired by a presentation from <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/ciberkleid">Cora Iberkleid</a> and <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/starbuxman">Josh Long</a> at the <a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=5IROOj7sLKg">Spring IO conference</a>.</p>
<p>You can find the entire code on my GitHub repo <a target="_blank" rel="noopener noreferrer" href="https://github.com/amrutprabhu/kubernetes-custom-resource">here</a>.</p>
<p>I keep exploring and learning new things. If you want to know the latest trends and improve your software development skills, then subscribe to my newsletter below and also follow me on <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/amrutprabhu42">Twitter</a>.</p>
<p>Enjoy!!</p></div><hr/></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/kubernetes">Kubernetes</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/yaml">yaml</a><a class="m-1 p-1 leading-4 h-6 rounded text-xs uppercase text-white bg-teal-500 hover:bg-teal-600 dark:hover:bg-teal-500 dark:bg-teal-600" href="/tags/docker">Docker</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/create-kubernetes-custom-resource-definition-crd">Part 1: How to Create a Kubernetes Custom Resource Definition (CRD)</a></div></div><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/fix-keycloak-oauth2-oidc-logout-with-spring-cloud-gateway">How To Fix Keycloak Oauth2 OIDC Logout With Spring Cloud Gateway</a></div></div></div></div><div class="pt-4 xl:pt-8 xl:mb-8 mb-4"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/">← Back to the articles</a></div><div class="border-4 border-teal-500 rounded-lg p-1"><a target="_blank" rel="noopener noreferrer" href="https://transactions.sendowl.com/stores/15382/235788"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTA1NCIgaGVpZ2h0PSIyMTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIvPg=="/></span><img alt="title" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="object-cover object-center " style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="title" srcSet="/static/images/promotion/testing-spring-boot-applications-masterclass-architecture-524x733.png?imwidth=1080 1x, /static/images/promotion/testing-spring-boot-applications-masterclass-architecture-524x733.png?imwidth=3840 2x" src="/static/images/promotion/testing-spring-boot-applications-masterclass-architecture-524x733.png?imwidth=3840" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="object-cover object-center " loading="lazy"/></noscript></span></a></div></footer></div></div></article></div></main><div class="ml-form-embed" data-account="3117349:p5v1c3m1v8" data-form="4015126:i6h8m5"></div><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:contact@refactorfirst.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/amrutprabhu"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/amrut-prabhu-722baa65/"><span class="sr-only">linkedin</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/amrutprabhu42"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Amrut Prabhu</div><div> • </div><div>© 2022</div><div> • </div><a href="/">RefactorFirst</a><div> • </div><a href="/privacy">Privacy Policy</a></div><br/></div></footer></div></div><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-6xl xl:px-0"><div id="cookie-notice" class="consent_consentname__aF_O7"><br/><br/><p>By clicking “I Accept”, you agree to the storing of cookies on your device to enhance site navigation and analyze site usage</p><br/><br/><div><a id="cookie-notice-accept" class="consent_greenButton__K0FRN">I Accept</a><a href="/privacy">Privacy Policy</a></div><br/><br/><br/></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var t=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var i=a=\u003et(a,\"__esModule\",{value:!0});var N=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=\u003e{i(a);for(var c in s)t(a,c,{get:s[c],enumerable:!0})},g=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let n of h(s))!m.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026t(a,n,{get:()=\u003es[n],enumerable:!(c=p(s,n))||c.enumerable});return a},w=a=\u003eg(i(t(a!=null?d(u(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var r=N((x,o)=\u003e{o.exports=_jsx_runtime});var I={};k(I,{default:()=\u003ey,frontmatter:()=\u003ef});var e=w(r()),f={title:\"Part 2: How to Create a Spring Boot Kubernetes Controller\",author:\"Amrut Prabhu\",categories:\"\",tags:[\"Kubernetes\",\"yaml\",\"Docker\"],\"photo-credits\":null,\"applaud-link\":\"2021/spring-boot-stream-kafka.json\",date:\"2022-07-21\",draft:!1,summary:\" In this article, we learn how to create a Spring Boot based Kubernetes Controller and explore the various components needed to create it.\",imageUrl:\"/static/images/2022/create-kubernetes-controller-with-spring/cover.jpg\",actualUrl:\"auto-generated\",customUrl:\"auto-generated\"};function b(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(c,{})})):c();function c(){let n=Object.assign({p:\"p\",a:\"a\",h1:\"h1\",span:\"span\",ul:\"ul\",li:\"li\",pre:\"pre\",code:\"code\",blockquote:\"blockquote\",strong:\"strong\",h2:\"h2\",div:\"div\"},a.components),{Image:l}=n;return l||C(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.p,{children:[\"In my earlier article \",(0,e.jsx)(n.a,{href:\"https://refactorfirst.com/create-kubernetes-custom-resource-definition-crd\",children:\"here\"}),\", we saw how we can create a Kubernetes Custom Resource Definition (CRD) and deploy it to a Kubernetes cluster. In this article, we will look at creating a Kubernetes Controller using Spring Boot that will handle requests when a CRD instance is created, updated, or deleted.\"]}),`\n`,(0,e.jsxs)(n.h1,{id:\"project-setup\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#project-setup\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Project Setup\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Let\\u2019s go to \",(0,e.jsx)(n.a,{href:\"https://start.spring.io\",children:\"https://start.spring.io\"}),\" and create a new project with the following dependencies.\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Spring Starter Web\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"Next, you need to add the Kubernetes Java client dependency as below\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-xml\",children:(0,e.jsxs)(n.code,{className:\"language-xml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),\"dependency\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),\"groupId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),\"io.kubernetes\",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c/\"}),\"groupId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),\"artifactId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),\"client-java-spring-integration\",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c/\"}),\"artifactId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),\"version\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),\"16.0.0\",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c/\"}),\"version\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c/\"}),\"dependency\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"With this, we are ready with the setup.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"generating-java-model-classes-for-crd\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#generating-java-model-classes-for-crd\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Generating Java Model Classes For CRD\"]}),`\n`,(0,e.jsx)(n.p,{children:\"In order to work with the Kubernetes CRD, we created in the previous article, we would need to get Java class representations of the CRD.\"}),`\n`,(0,e.jsx)(n.p,{children:\"We can use a utility that will generate the class files from a deployed CRD.\"}),`\n`,(0,e.jsx)(n.p,{children:\"For this, you need to have docker running and then run the following command.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token shebang important\",children:\"#!/usr/bin/env bash\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token assign-left variable\",children:\"LOCAL_MANIFEST_FILE\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`/home/amrut/projects/kubernetes-custom-resource/crd/my-crd.yaml\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"mkdir\"}),\" -p /tmp/java \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" \",(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"cd\"}),` /tmp/java\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"docker run \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  --rm \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -v \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsx)(n.span,{className:\"token variable\",children:\"$LOCAL_MANIFEST_FILE\"}),'\"']}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsx)(n.span,{className:\"token variable\",children:\"$LOCAL_MANIFEST_FILE\"}),'\"']}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -v /var/run/docker.sock:/var/run/docker.sock \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -v \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsxs)(n.span,{className:\"token variable\",children:[(0,e.jsx)(n.span,{className:\"token variable\",children:\"$(\"}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"pwd\"}),(0,e.jsx)(n.span,{className:\"token variable\",children:\")\"})]}),'\"']}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsxs)(n.span,{className:\"token variable\",children:[(0,e.jsx)(n.span,{className:\"token variable\",children:\"$(\"}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"pwd\"}),(0,e.jsx)(n.span,{className:\"token variable\",children:\")\"})]}),'\"']}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -ti \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  --network \",(0,e.jsx)(n.span,{className:\"token function\",children:\"host\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  ghcr.io/kubernetes-client/java/crd-model-gen:v1.0.6 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  /generate.sh \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -u \",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$LOCAL_MANIFEST_FILE\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -n prabhu.amrut.com \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -p com.amrut.prabhu \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  -o \",(0,e.jsxs)(n.span,{className:\"token string\",children:['\"',(0,e.jsxs)(n.span,{className:\"token variable\",children:[(0,e.jsx)(n.span,{className:\"token variable\",children:\"$(\"}),(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"pwd\"}),(0,e.jsx)(n.span,{className:\"token variable\",children:\")\"})]}),'\"']}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Let me explain what this command does.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"It first creates a temp directory to store the generated classes. It then starts a \",(0,e.jsx)(n.a,{href:\"https://refactorfirst.com/kind-kubernetes-cluster\",children:\"Kind Kubernetes Cluster\"}),\" using Docker, applies the mounted Kubernetes CRD file to the cluster, and generates the Java class files from the deployed CRD in the temp directory.\"]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"Important note\"}),\": The flag -n should be the reverse order of the group name. In our case its \",(0,e.jsx)(n.code,{children:\"prabhu.amrut.com\"}),\" since the group name was \",(0,e.jsx)(n.code,{children:\"com.amrut.prabhu\"})]}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[\"You can always read about this in their documentation \",(0,e.jsx)(n.a,{href:\"https://github.com/kubernetes-client/java/blob/master/docs/generate-model-from-third-party-resources.md#example-commands-for-local-crd-manifests\",children:\"here\"}),\".\"]}),`\n`,(0,e.jsxs)(n.h1,{id:\"understanding-the-use-case\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#understanding-the-use-case\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Understanding the Use Case\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Before we start creating the controller, let\\u2019s understand the use case we want to achieve.\"}),`\n`,(0,e.jsx)(n.p,{children:\"When we create a CRD instance, we want the controller to create a Kubernetes config map. If the CRD instance is updated, the controller updates the config map and similarly, if it is deleted, the config map is deleted.\"}),`\n`,(0,e.jsx)(n.p,{children:\"With this understanding, Let\\u2019s create our Kubernetes Controller.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"creating-a-kubernetes-controller\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#creating-a-kubernetes-controller\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Creating a Kubernetes Controller\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now to create a controller, we need to create a few components.\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"A reconciler: This component is used to handle requests when there is a change in the CRD instance. It will be invoked when we create, update or delete a CRD instance so that we can do something with the changes.\"}),`\n`,(0,e.jsx)(n.li,{children:\"A Shared Index Informer: This is more like a cache, so the controller does not need to continuously poll the Kubernetes cluster (API server) to check if there are any new CRD instances created, updated, or deleted.\"}),`\n`,(0,e.jsx)(n.li,{children:\"APIClient: It is a client used to connect to the Kubernetes Cluster (API server)\"}),`\n`,(0,e.jsx)(n.li,{children:\"CRD Model: These are the model classes we generated earlier.\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s start with creating the first component which is the shared index informer.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@Bean\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token class-name\",children:\"SharedIndexInformer\"}),(0,e.jsxs)(n.span,{className:\"token generics\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrd\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"sharedIndexInformer\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"SharedInformerFactory\"}),\" sharedInformerFactory\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ApiClient\"}),\" apiClient\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"GenericKubernetesApi\"}),(0,e.jsxs)(n.span,{className:\"token generics\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrd\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrdList\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),\" api \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"GenericKubernetesApi\"}),(0,e.jsxs)(n.span,{className:\"token generics\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\u003e\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrd\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrdList\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"com.amrut.prabhu\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"v1\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"my-crds\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            apiClient\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" sharedInformerFactory\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"sharedIndexInformerFor\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"api\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrd\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`})]})}),`\n`,(0,e.jsx)(n.p,{children:\"So here, we create an index informer, which will be having a reference of an APIClient to look for any created instances of the CRD.\"}),`\n`,(0,e.jsxs)(n.h2,{id:\"understanding-the-reconciler-component\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#understanding-the-reconciler-component\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Understanding the Reconciler Component\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now, to understand what we should do in the reconciler, let\\u2019s see this with a small flow chart.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(l,{alt:\"Reconciler Flowchart\",src:\"/static/images/2022/create-kubernetes-controller-with-spring/reconciler-flowchart.png\",width:\"683\",height:\"1398\"})}),`\n`,(0,e.jsx)(n.p,{children:\"This is the simplest algorithm.\"}),`\n`,(0,e.jsx)(n.p,{children:\"As you can see in the flow chart, there are 3 variants of the incoming requests i.e Create, Update, and Delete.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s look at them.\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Create Instance Request:- When we receive this request, we get a reference to the resource instance from the index informer. We can then do something like creating a config map. Now, when we create a new resource as a result of CRD instance creation, we need to set the current CRD instance as the owner of the new resource. Why? we will find out soon.\"}),`\n`,(0,e.jsx)(n.li,{children:\"Update Instance Request: In this case, we get an updated reference of the CRD instance and we perform an update on our components i.e. update the previously created config map.\"}),`\n`,(0,e.jsx)(n.li,{children:\"Delete Instance Request: In this case, we don't have to do anything. As soon as we delete the CRD instance, Kubernetes automatically deletes all the resources it owns. This is why we set the ownership while creating a new resource.\"}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"implementing-the-reconciler-component\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#implementing-the-reconciler-component\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Implementing the Reconciler Component\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s look at the reconciler code in two parts.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"request \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\u003e\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"String\"}),\" key \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" request\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getNamespace\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"/\"'}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" request\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getName\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrd\"}),\" resourceInstance \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),` shareIndexInformer\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getIndexer\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getByKey\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"key\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"resourceInstance \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"null\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1ConfigMap\"}),\" v1ConfigMap \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"createConfigMap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"resourceInstance\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"try\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            coreV1Api\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"createNamespacedConfigMap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"request\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getNamespace\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    v1ConfigMap\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"true\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"null\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"catch\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ApiException\"}),\" e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Here, when the request that comes in just contains the namespace and the name of the resource that was created. We then fetch the reference to the CRDS instance using the shared index former. If the instance was created, we would get a reference, or else it will be null indicating the instance was deleted. Once we get the reference, we then create a Kubernetes config map using the CoreAPI.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Let\\u2019s look at the config map creation function.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"private\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1ConfigMap\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"createConfigMap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1MyCrd\"}),\" resourceInstance\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1ConfigMap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"metadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1ObjectMeta\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"my-config-map\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"addOwnerReferencesItem\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"V1OwnerReference\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"apiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"resourceInstance\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getApiVersion\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"kind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"resourceInstance\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getKind\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"name\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"resourceInstance\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getMetadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getName\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"uid\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"resourceInstance\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getMetadata\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getUid\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"data\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Map\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"_of_\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"amrut\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"prabhu\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"If you see here, I create a new config map object and set the reference of the current CRD instance as the owner of the config map.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Now let\\u2019s look at what happens during the update.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"catch\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ApiException\"}),\" e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"System\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"_out_\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"println\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getCode\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"409\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"try\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            coreV1Api\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"replaceNamespacedConfigMap\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"my-config-map\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    request\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getNamespace\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    v1ConfigMap\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"true\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"null\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"                    \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"catch\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ApiException\"}),\" ex\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"throw\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"RuntimeException\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"ex\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"throw\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"RuntimeException\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"When we receive an update, the index informer just gives us a reference to the updated CRD instance, and we still don't know if the incoming request is for a create or update.\"}),`\n`,(0,e.jsx)(n.p,{children:\"So we proceed with a normal create approach, which fails by throwing an exception with a code 409, which means the resource is already created. We then know that the current request is an update and update the config map.\"}),`\n`,(0,e.jsx)(n.p,{children:\"In the case of the delete, we don't have to do anything. Kubernetes will automatically delete all the resources owned by our CRD instance.\"}),`\n`,(0,e.jsx)(n.p,{children:\"This is the reason we need to set the CRD instance as the owner of all the resources we created while handling the CRD instance creation request.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(l,{alt:\"CRD apply output\",src:\"/static/images/2022/create-kubernetes-controller-with-spring/crds-instance-apply-output.png\",width:\"1908\",height:\"708\"})}),`\n`,(0,e.jsxs)(n.h1,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#conclusion\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Today we created a Spring Boot Kubernetes controller and handled requests for our own Kubernetes CRD instance creation, update, or deletion.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"This article is largely inspired by a presentation from \",(0,e.jsx)(n.a,{href:\"https://twitter.com/ciberkleid\",children:\"Cora Iberkleid\"}),\" and \",(0,e.jsx)(n.a,{href:\"https://twitter.com/starbuxman\",children:\"Josh Long\"}),\" at the \",(0,e.jsx)(n.a,{href:\"https://www.youtube.com/watch?v=5IROOj7sLKg\",children:\"Spring IO conference\"}),\".\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"You can find the entire code on my GitHub repo \",(0,e.jsx)(n.a,{href:\"https://github.com/amrutprabhu/kubernetes-custom-resource\",children:\"here\"}),\".\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"I keep exploring and learning new things. If you want to know the latest trends and improve your software development skills, then subscribe to my newsletter below and also follow me on \",(0,e.jsx)(n.a,{href:\"https://twitter.com/amrutprabhu42\",children:\"Twitter\"}),\".\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Enjoy!!\"})]})}}var y=b;function C(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return I;})();\n;return Component;","toc":[{"value":"Project Setup","url":"#project-setup","depth":1},{"value":"Generating Java Model Classes For CRD","url":"#generating-java-model-classes-for-crd","depth":1},{"value":"Understanding the Use Case","url":"#understanding-the-use-case","depth":1},{"value":"Creating a Kubernetes Controller","url":"#creating-a-kubernetes-controller","depth":1},{"value":"Understanding the Reconciler Component","url":"#understanding-the-reconciler-component","depth":2},{"value":"Implementing the Reconciler Component","url":"#implementing-the-reconciler-component","depth":2},{"value":"Conclusion","url":"#conclusion","depth":1}],"frontMatter":{"readingTime":{"text":"9 min read","minutes":8.42,"time":505200,"words":1684},"slug":"2022/java-spring-boot-kubernetes-controller","fileName":"2022/java-spring-boot-kubernetes-controller.md","title":"Part 2: How to Create a Spring Boot Kubernetes Controller","author":"Amrut Prabhu","categories":"","tags":["Kubernetes","yaml","Docker"],"photo-credits":null,"applaud-link":"2021/spring-boot-stream-kafka.json","date":"2022-07-21T00:00:00.000Z","draft":false,"summary":" In this article, we learn how to create a Spring Boot based Kubernetes Controller and explore the various components needed to create it.","imageUrl":"/static/images/2022/create-kubernetes-controller-with-spring/cover.jpg","actualUrl":"2022/java-spring-boot-kubernetes-controller","customUrl":"java-spring-boot-kubernetes-controller"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.875,"time":52500,"words":175},"slug":["default"],"fileName":"default.md","name":"Amrut Prabhu","avatar":"/static/images/avatar-small.jpg","avatarBig":"/static/images/avatar-big.jpg","occupation":"Staff Engineer","company":"Personal","email":"contact@refactorfirst.com","twitter":"https://twitter.com/amrutprabhu42","linkedin":"https://www.linkedin.com/in/amrut-prabhu-722baa65/","github":"https://github.com/amrutprabhu","customUrl":"default","actualUrl":"default","date":null}],"prev":{"title":"Part 1: How to Create a Kubernetes Custom Resource Definition (CRD)","author":"Amrut Prabhu","categories":"","tags":["Kubernetes","yaml","Docker"],"photo-credits":null,"applaud-link":"2021/spring-boot-stream-kafka.json","date":"2022-07-07T00:00:00.000Z","draft":false,"summary":" In this article, we understand how Kubernetes handles its resources and create our own Kubernetes Custom Resource Definition (CRD)","imageUrl":"/static/images/2022/create-kubernetes-custom-resource-defintion-crd/cover.jpg","actualUrl":"2022/create-kubernetes-custom-resource-definition-crd","customUrl":"create-kubernetes-custom-resource-definition-crd","slug":"create-kubernetes-custom-resource-definition-crd"},"next":{"title":"How To Fix Keycloak Oauth2 OIDC Logout With Spring Cloud Gateway","author":"Amrut Prabhu","categories":"","tags":["Spring Boot","Java","Gateway","Keycloak","Oauth2","OpenId Connect","Resource Server","Docker"],"photo-credits":null,"applaud-link":"2021/spring-boot-stream-kafka.json","date":"2022-08-11T00:00:00.000Z","draft":false,"summary":" In this article, we look at how we can fix the keycloak Oauth2 OIDC logout issue with Spring Cloud Gateway","imageUrl":"/static/images/2022/fix-keycloak-oidc-logout-issue/cover.jpg","actualUrl":"2022/fix-keycloak-oauth2-oidc-logout-with-spring-cloud-gateway","customUrl":"fix-keycloak-oauth2-oidc-logout-with-spring-cloud-gateway","slug":"fix-keycloak-oauth2-oidc-logout-with-spring-cloud-gateway"}},"__N_SSG":true},"page":"/[slug]","query":{"slug":"java-spring-boot-kubernetes-controller"},"buildId":"d-J57GRCfk9HGzn9Oxtu8","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>