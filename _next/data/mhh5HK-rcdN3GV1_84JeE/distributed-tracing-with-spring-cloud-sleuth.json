{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var d=Object.create;var c=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var l=a=>c(a,\"__esModule\",{value:!0});var N=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),k=(a,s)=>{l(a);for(var t in s)c(a,t,{get:s[t],enumerable:!0})},g=(a,s,t)=>{if(s&&typeof s==\"object\"||typeof s==\"function\")for(let n of p(s))!m.call(a,n)&&n!==\"default\"&&c(a,n,{get:()=>s[n],enumerable:!(t=h(s,n))||t.enumerable});return a},w=a=>g(l(c(a!=null?d(u(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var o=N((I,r)=>{r.exports=_jsx_runtime});var S={};k(S,{default:()=>v,frontmatter:()=>b});var e=w(o()),b={title:\"Distributed Tracing with Spring Cloud Sleuth And Zipkin\",author:\"Amrut Prabhu\",tags:[\"Spring Boot\",\"Java\",\"Distributed Tracing\",\"Zipkin\"],\"photo-credits\":\"https://unsplash.com/photos/d9ILr-dbEdg\",\"applaud-link\":\"2021/distributed-tracing-with-spring-zipkin.json\",date:\"2021-08-19\",draft:!1,summary:\"We would learn how we can implement distributed tracing in a Spring Boot Application and understand the key concepts of distributed tracing\",imageUrl:\"/static/images/2021/distributed-tracing-with-zipkin/cover.jpg\",actualUrl:\"auto-generated\",customUrl:\"auto-generated\"};function f(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(t,{})})):t();function t(){let n=Object.assign({p:\"p\",h1:\"h1\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",div:\"div\",pre:\"pre\",code:\"code\",h3:\"h3\",h2:\"h2\"},a.components),{Image:i}=n;return i||y(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"In this article, we would learn how we can implement distributed tracing and understand the key concepts of distributed tracing.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"introduction\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#introduction\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Introduction\"]}),`\n`,(0,e.jsx)(n.p,{children:\"In the case of a single giant application that does everything which we usually refer to as a monolith, tracing the incoming request within the application was easy. We could follow the logs and then figure out how the request was being handled. There was nothing else we would have to look at but the application logs themselves.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Over time, monoliths become difficult to scale, to serve a large number of requests as well as delivering new features to the customer with the growing size of the codebase. This leads to breaking down the monolith into microservice which helps in scaling individual components and also helps to deliver faster.\"}),`\n`,(0,e.jsx)(n.p,{children:\"But not all that shines is gold, right? It's the same thing with microservices. We split the entire monolith system into microservices and every request that was processed by a set of local function calls is now replaced by calling a set of distributed services. With this, we lose things like tracing a request that was easily done in a monolith. Now to trace each request we would have to look at the logs of each service and it becomes difficult to correlate.\"}),`\n`,(0,e.jsx)(n.p,{children:\"So in the case of distributed systems, the concept of distributed tracing helps with tracing a request.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"what-is-distributed-tracing\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#what-is-distributed-tracing\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"What is Distributed Tracing?\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Distributed tracing is a mechanism with which we can trace a particular request throughout a distributed system. It allows us to track how a request progresses from one system to another thereby completing the user\\u2019s request.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"key-concepts-of-distributed-tracing\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#key-concepts-of-distributed-tracing\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Key concepts of Distributed Tracing.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Distributed tracing consists of two main concepts\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"Trace Id\"}),`\n`,(0,e.jsx)(n.li,{children:\"Span Id\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"Trace Id is used to trace an incoming request and track it across all the composing services to satisfy a request.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Span Id is more of spans in between service calls to track each request that is received and to the response that is sent out.\"}),`\n`,(0,e.jsx)(n.p,{children:\"let's have a look at the diagram.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"distributed-tracing diagram\",src:\"/static/images/2021/distributed-tracing-with-zipkin/distributed-tracing-diagram.png\",width:\"735\",height:\"362\"})}),`\n`,(0,e.jsx)(n.p,{children:\"The incoming request doesn\\u2019t have any Trace id, the first service intercepting the call generates the trace id \\u201CID1\\u201D and its span id \\u201CA\\u201D. The span id \\u201CB\\u201D covers the time from when the client at server 1 sent out the request, then server 2 receiving it, processing it, and sending out the response.\"}),`\n`,(0,e.jsx)(n.p,{children:\"With the concepts understood, let\\u2019s now do this practically and understand more inside details.\"}),`\n`,(0,e.jsxs)(n.h1,{id:\"spring-boot-example-with-spring-cloud-sleuth\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#spring-boot-example-with-spring-cloud-sleuth\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Spring Boot Example With Spring Cloud Sleuth\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Let\\u2019s create an application with spring cloud sleuth integrated. To start, let's go to \",(0,e.jsx)(n.a,{href:\"https://start.spring.io/\",children:\"https://start.spring.io/\"}),\" and create an application with the dependencies \\u201CSpring Web\\u201D and \\u201CSpring Cloud Sleuth\\u201D.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now let\\u2019s create a simple controller with two request mapping.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Controller\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"private\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"static\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"final\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Logger\"}),\" logger \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"LoggerFactory\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getLogger\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Controller\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"private\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"RestTemplate\"}),\" restTemplate\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@Value\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"${spring.application.name}\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"private\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"String\"}),\" applicationName\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Controller\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"RestTemplate\"}),\" restTemplate\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"this\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"restTemplate \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" restTemplate\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@GetMapping\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"/path1\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ResponseEntity\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"path1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  logger\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"info\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Request at {} for request /path1 \"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" applicationName\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"String\"}),\" response \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" restTemplate\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"getForObject\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"http://localhost:8090/service/path2\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"String\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ResponseEntity\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"ok\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"response from /path1 + \"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" response\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@GetMapping\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"/path2\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ResponseEntity\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"path2\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  logger\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"info\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"Request at {} at /path2\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" applicationName\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ResponseEntity\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"ok\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"response from /path2 \"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Here I have created two paths, \",(0,e.jsx)(n.code,{children:\"Path1\"}),\" calling \",(0,e.jsx)(n.code,{children:\"Path2\"}),\" at a fixed port 8090. The idea here is to run two separate instances of the same application.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Now to allow sleuth to inject headers into the outgoing request, we need the RestTemplate to be injected as a bean rather than initializing it directly. This will allow sleuth to add an interceptor to the RestTemplate to inject a header with the trace id and span id into the outgoing request.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-java\",children:(0,e.jsxs)(n.code,{className:\"language-java code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token annotation punctuation\",children:\"@Bean\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"RestTemplate\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"restTemplate\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token class-name\",children:\"RestTemplateBuilder\"}),\" builder\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" builder\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"build\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Now, let's start the two instances. To do that, first, build the application with \",(0,e.jsx)(n.code,{children:\"mvn clean verify\"}),\" and then run the following command to start \\u201CService 1\\u201D\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"java -jar \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"target/Distributed-Service-0.0.1-SNAPSHOT.jar \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"--spring.application.name\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"Service-1 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"--server.port\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8080\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Then on a different terminal run \\u201CService 2\\u201D as follows\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"java -jar \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"target/Distributed-Service-0.0.1-SNAPSHOT.jar \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"--spring.application.name\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"Service-2 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"\\\\\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"--server.port\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8090\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Once the application starts, call \\u201CService 1\\u201D at \",(0,e.jsx)(n.code,{children:\"/path1\"}),\" as follows\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-shell\",children:(0,e.jsx)(n.code,{className:\"language-shell code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"curl\"}),` -i http://localhost:8080/service/path1\n`]})})}),`\n`,(0,e.jsx)(n.p,{children:\"Now let\\u2019s look at the logs of \\u201CService 1\\u201D.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"INFO \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"Service-1,222f3b00a283c75c,222f3b00a283c75c\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"41114\"}),\" --- \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"nio-8080-exec-1\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" c.a.p.distributedservice.Controller      \",(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),\" Incoming request at Service-1 \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),` request /path1\n`]})})}),`\n`,(0,e.jsx)(n.p,{children:\"The log contains square brackets with three parts [ Service name, Trace Id, Span Id ]. For the first incoming request, since there is no incoming trace id, the span id is the same as the trace id.\"}),`\n`,(0,e.jsx)(n.p,{children:\"Looking at the logs of \\u201CService 2\\u201D, we see that we have a new span id for this request.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"INFO \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"Service-2,222f3b00a283c75c,13194db963293a22\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"41052\"}),\" --- \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"nio-8090-exec-1\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" c.a.p.distributedservice.Controller      \",(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\":\"}),` Incoming request at Service-2 at /path2\n`]})})}),`\n`,(0,e.jsx)(n.p,{children:\"I intercepted the request being sent out of \\u201CService 1\\u201D to \\u201CService 2\\u201D and found the following headers already present in the outgoing request.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-properties\",children:(0,e.jsxs)(n.code,{className:\"language-properties code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token attr-name\",children:\"x-b3-traceid\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token attr-value\",children:'\"222f3b00a283c75c\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token attr-name\",children:\"x-b3-spanid\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token attr-value\",children:'\"13194db963293a22\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token attr-name\",children:\"x-b3-parentspanid\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token attr-value\",children:'\"222f3b00a283c75c'}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"Here we see, the span for the next operation (call to \\u201CService 2\\u201D) is already injected in the headers. These were injected by \\u201CService 1\\u201D when the client was sending out the request. This means the span for the next call to \\u201CService 2\\u201D is already started from the client of \\u201CService 1\\u201D. In the headers shown above, The span id of \\u201CService 1\\u201D is now the parent span id for the next span.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"Now to make things easier to understand, we can visually see the traces using an interceptor tool called \",(0,e.jsx)(n.a,{href:\"https://zipkin.io/\",children:\"Zipkin\"}),\".\"]}),`\n`,(0,e.jsxs)(n.h3,{id:\"visualizing-traces-with-zipkin\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#visualizing-traces-with-zipkin\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Visualizing Traces with Zipkin\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"To integrate \",(0,e.jsx)(n.a,{href:\"https://zipkin.io/\",children:\"Zipkin\"}),\" with the application, we would need to add a Zipkin client dependency to the application.\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-xml\",children:(0,e.jsxs)(n.code,{className:\"language-xml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"<\"}),\"dependency\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"<\"}),\"groupId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"})]}),\"org.springframework.cloud\",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"</\"}),\"groupId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"<\"}),\"artifactId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"})]}),\"spring-cloud-sleuth-zipkin\",(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"</\"}),\"artifactId\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"})]}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsxs)(n.span,{className:\"token tag\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"</\"}),\"dependency\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\">\"})]}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"On adding this dependency, the Zipkin client by default sends the traces to the Zipkin server at port 9411.\"}),`\n`,(0,e.jsx)(n.p,{children:\"let\\u2019s start the Zipkin server using its docker image. I created a simple docker-compose file for this.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"version\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'3.1'\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"services\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"zipkin\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"image\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" openzipkin/zipkin\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"ports\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'9411:9411'\"}),`\n`]})]})}),`\n`,(0,e.jsxs)(n.p,{children:[\"We can now start the server using \",(0,e.jsx)(n.code,{children:\"docker-compose up\"}),\" command. You can then access the UI at \",(0,e.jsx)(n.code,{children:\"http://localhost:9411/\"})]}),`\n`,(0,e.jsx)(n.p,{children:\"Since we are using the default port, we don\\u2019t need to specify any properties, But if you plan to have a different port, you would need to add the following property.\"}),`\n`,(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"language-yaml code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"spring\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"zipkin\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token key atrule\",children:\"baseUrl\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" http\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\"//localhost\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"9411\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"With this done, let's start both the applications using the same commands from above.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"On placing a request to \\u201CService 1\\u201D at the path \",(0,e.jsx)(n.code,{children:\"/path1\"}),\" we get the following traces.\"]}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Distributed tracing View\",src:\"/static/images/2021/distributed-tracing-with-zipkin/distributed-trace-view.png\",width:\"1146\",height:\"348\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Here it shows the spans for the two services. We can dig deeper by looking at the spans.\"}),`\n`,(0,e.jsx)(n.p,{children:\"The span for \\u201CService 1\\u201D is a normal span covering from when it received the request to it returning a response.\"}),`\n`,(0,e.jsx)(n.p,{children:\"The interesting one is the second span.\"}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Distributed trace 2\",src:\"/static/images/2021/distributed-tracing-with-zipkin/distributed-trace-2.png\",width:\"765\",height:\"623\"})}),`\n`,(0,e.jsx)(n.p,{children:\"In this, there are 4 points in the span.\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"The first point refers to when the client from \\u201CService 1\\u201D started the request\"}),`\n`,(0,e.jsx)(n.li,{children:\"The second point is when \\u201CService 2\\u201D started processing the request.\"}),`\n`,(0,e.jsx)(n.li,{children:\"The third point is when the client on \\u201CServer 1\\u201D finished receiving the response.\"}),`\n`,(0,e.jsx)(n.li,{children:\"And finally, the last point when \\u201CServer 2\\u201D finished.\"}),`\n`]}),`\n`,(0,e.jsx)(n.div,{children:(0,e.jsx)(i,{alt:\"Tracing span details\",src:\"/static/images/2021/distributed-tracing-with-zipkin/distributed-tracing-details.jpg\",width:\"3863\",height:\"1849\"})}),`\n`,(0,e.jsxs)(n.h1,{id:\"conclusion\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#conclusion\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),`\n`,(0,e.jsx)(n.p,{children:\"So with this, we have learned how we can integrate distributed tracing with spring cloud sleuth and also visualized the traces using Zipkin.\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"I have uploaded the code on \",(0,e.jsx)(n.a,{href:\"https://github.com/amrutprabhu/distributed-tracing-with-spring-boot/tree/main/distributed-tracing-spring-cloud-sleuth-zipkin\",children:\"GitHub\"}),\".\"]}),`\n`,(0,e.jsxs)(n.h2,{id:\"youtube-video\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#youtube-video\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"YouTube Video\"]}),`\n`,(0,e.jsx)(n.p,{children:\"You can have a visual walk-through in the video below.\"}),`\n`,(0,e.jsx)(\"iframe\",{width:\"560\",height:\"315\",src:\"https://www.youtube.com/embed/m9a11SD8ITc\",frameBorder:\"0\",allowFullScreen:!0})]})}}var v=f;function y(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return S;})();\n;return Component;","toc":[{"value":"Introduction","url":"#introduction","depth":1},{"value":"What is Distributed Tracing?","url":"#what-is-distributed-tracing","depth":1},{"value":"Key concepts of Distributed Tracing.","url":"#key-concepts-of-distributed-tracing","depth":1},{"value":"Spring Boot Example With Spring Cloud Sleuth","url":"#spring-boot-example-with-spring-cloud-sleuth","depth":1},{"value":"Visualizing Traces with Zipkin","url":"#visualizing-traces-with-zipkin","depth":3},{"value":"Conclusion","url":"#conclusion","depth":1},{"value":"YouTube Video","url":"#youtube-video","depth":2}],"frontMatter":{"readingTime":{"text":"8 min read","minutes":7.8,"time":468000,"words":1560},"slug":"2021/distributed-tracing-with-spring-cloud-sleuth","fileName":"2021/distributed-tracing-with-spring-cloud-sleuth.md","title":"Distributed Tracing with Spring Cloud Sleuth And Zipkin","author":"Amrut Prabhu","tags":["Spring Boot","Java","Distributed Tracing","Zipkin"],"photo-credits":"https://unsplash.com/photos/d9ILr-dbEdg","applaud-link":"2021/distributed-tracing-with-spring-zipkin.json","date":"2021-08-19T00:00:00.000Z","draft":false,"summary":"We would learn how we can implement distributed tracing in a Spring Boot Application and understand the key concepts of distributed tracing","imageUrl":"/static/images/2021/distributed-tracing-with-zipkin/cover.jpg","actualUrl":"2021/distributed-tracing-with-spring-cloud-sleuth","customUrl":"distributed-tracing-with-spring-cloud-sleuth"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.875,"time":52500,"words":175},"slug":["default"],"fileName":"default.md","name":"Amrut Prabhu","avatar":"/static/images/avatar-small.jpg","avatarBig":"/static/images/avatar-big.jpg","occupation":"Staff Engineer","company":"Personal","email":"address@yoursite.com","twitter":"https://twitter.com/amrutprabhu42","linkedin":"https://www.linkedin.com/in/amrut-prabhu-722baa65/","github":"https://github.com/amrutprabhu","customUrl":"default","actualUrl":"default","date":null}],"prev":{"title":"Micronaut JPA Application Performance on AWS Lambda","author":"Amrut Prabhu","categories":"","tags":["Spring Boot","Micronaut","AWS","AWS Lambda","Native Image","Java"],"image":"micronaut-lambda-application/cover.jpg","photo-credits":null,"applaud-link":"micronaut-aws-lambda-application-for-api-gateway.json","date":"2021-08-12T00:00:00.000Z","draft":false,"summary":"In this article, we would be looking into how we can deploy a Micronaut application providing GET, PUT and POST which can be called using an API Gateway and check its performance","imageUrl":"/static/images/2021/micronaut-lambda-application/cover.jpg","actualUrl":"2020/micronaut-aws-lambda-application-for-api-gateway","customUrl":"micronaut-aws-lambda-application-for-api-gateway","slug":"micronaut-aws-lambda-application-for-api-gateway"},"next":{"title":"Spring Cloud Gateway Keycloak OAuth2 OIDC Integration","author":"Amrut Prabhu","categories":"","tags":["Spring Boot","Java","Gateway","Keycloak","Oauth2","OpenId Connect"],"photo-credits":"","applaud-link":"2021/spring-gateway-oauth2-keycloak.json","date":"2021-09-02T00:00:00.000Z","draft":false,"summary":"In this article, we would be looking at how we can integrate Keycloak with Spring Cloud Gateway using the OAuth2 OpenId Connect (OIDC).","imageUrl":"/static/images/2021/spring-cloud-gateway-with-keycloak/cover.jpg","actualUrl":"2021/spring-cloud-gateway-keycloak-oauth2-openid-connect","customUrl":"spring-cloud-gateway-keycloak-oauth2-openid-connect","slug":"spring-cloud-gateway-keycloak-oauth2-openid-connect"}},"__N_SSG":true}