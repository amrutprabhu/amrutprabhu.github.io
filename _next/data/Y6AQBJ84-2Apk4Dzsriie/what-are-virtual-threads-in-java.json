{"pageProps":{"post":{"mdxSource":"var Component=(()=>{var l=Object.create;var o=Object.defineProperty;var c=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var h=a=>o(a,\"__esModule\",{value:!0});var g=(a,r)=>()=>(r||a((r={exports:{}}).exports,r),r.exports),f=(a,r)=>{h(a);for(var n in r)o(a,n,{get:r[n],enumerable:!0})},w=(a,r,n)=>{if(r&&typeof r==\"object\"||typeof r==\"function\")for(let t of u(r))!m.call(a,t)&&t!==\"default\"&&o(a,t,{get:()=>r[t],enumerable:!(n=c(r,t))||n.enumerable});return a},b=a=>w(h(o(a!=null?l(p(a)):{},\"default\",a&&a.__esModule&&\"default\"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var d=g((j,s)=>{s.exports=_jsx_runtime});var V={};f(V,{default:()=>y,frontmatter:()=>v});var e=b(d()),v={title:\"What Are Virtual Threads In Java\",author:\"Amrut Prabhu\",categories:\"\",tags:[\"Java\",\"JDK19\",\"Virtual Threads\",\"Multithreading\"],\"photo-credits\":\"https://unsplash.com/photos/NLgqFA9Lg_E\",\"applaud-link\":\"2021/spring-boot-stream-kafka.json\",date:\"2022-12-15\",draft:!1,summary:\"We will look into the concepts of Virtual threads that are provided as a preview feature in JDK 19\",imageUrl:\"/static/images/2022/what-are-virtual-threads/cover.jpg\",actualUrl:\"auto-generated\",customUrl:\"auto-generated\"};function k(a={}){let{wrapper:r}=a.components||{};return r?(0,e.jsx)(r,Object.assign({},a,{children:(0,e.jsx)(n,{})})):n();function n(){let t=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",code:\"code\",div:\"div\",strong:\"strong\"},a.components),{Image:i}=t;return i||x(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(t.h2,{id:\"introduction\",children:[(0,e.jsx)(t.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#introduction\",children:(0,e.jsx)(t.span,{className:\"icon icon-link\"})}),\"Introduction\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"Traditionally, performing multiple tasks at the same time was carried out by creating threads using \",(0,e.jsx)(t.code,{children:\"new Thread()\"}),\" or by using an executor service. These threads are called platform threads.\"]}),`\n`,(0,e.jsx)(t.p,{children:\"Platform threads would basically be wrappers around the kernel threads and are usually expensive to create. That is the reason, we create thread pools to avoid this expensive operation of creating threads.\"}),`\n`,(0,e.jsx)(t.p,{children:\"When a piece of code is running in a thread, the kernel thread is captured during the entire execution of the thread. If another thread wants to execute its code, it needs to capture a kernel thread to do its execution.\"}),`\n`,(0,e.jsx)(t.p,{children:\"This means, if you have more platform threads concurrently running than kernel threads, the performance would degrade as the threads would compete for the kernel-level threads and a lot of the time would be spent either waiting or for thread context switching.\"}),`\n`,(0,e.jsx)(t.p,{children:\"Hence for optimal performance, the number of concurrently running threads should be limited to the number of kernel-level threads. These platform-level threads are scheduled by the OS scheduler and the scheduling algorithm depends on the underlying OS.\"}),`\n`,(0,e.jsx)(t.p,{children:\"Let\\u2019s look at what Virtual threads bring to the Java ecosystem.\"}),`\n`,(0,e.jsxs)(t.h2,{id:\"what-are-virtual-threads\",children:[(0,e.jsx)(t.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#what-are-virtual-threads\",children:(0,e.jsx)(t.span,{className:\"icon icon-link\"})}),\"What are Virtual Threads?\"]}),`\n`,(0,e.jsx)(t.p,{children:\"Virtual threads are lightweight threads that are not the same as platform threads. They are not expensive to create and must not be pooled. You can create as many threads as you want and avoid reusing them.\"}),`\n`,(0,e.jsxs)(t.p,{children:[\"You can compare Virtual threads as Java\\u2019s equivalent to Goroutines in Golang. You can start using them by using the \",(0,e.jsx)(t.code,{children:\"--enable-preview\"}),\" flag during compilation and running an application.\"]}),`\n`,(0,e.jsx)(t.p,{children:\"Virtual threads help to improve throughput when you have a large number of tasks that are not CPU bound. I/O-intensive tasks are the primary ones that benefit from Virtual Threads. These tasks include things such as reading from queues, waiting for incoming web requests, database queries, etc.\"}),`\n`,(0,e.jsxs)(t.h2,{id:\"how-virtual-threads-work\",children:[(0,e.jsx)(t.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#how-virtual-threads-work\",children:(0,e.jsx)(t.span,{className:\"icon icon-link\"})}),\"How Virtual Threads Work\"]}),`\n`,(0,e.jsx)(t.p,{children:\"Virtual threads do not work directly on a kernel thread but rather are scheduled by the JVM using a scheduler on platform-level threads. This means Virtual threads share the platform-level threads with each other during the execution of the code.\"}),`\n`,(0,e.jsxs)(t.p,{children:[\"For scheduling these threads, the JDK provides a work-stealing \",(0,e.jsx)(t.code,{children:\"ForkJoinPool\"}),\" scheduler that will schedule the Virtual threads on the platform threads in a FIFO manner.\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"By default, the number of platform-level threads available to the scheduler is equal to the number of kernel-level threads. This can be changed with the system property \",(0,e.jsx)(t.code,{children:\"jdk.virtualThreadScheduler.maxPoolSize\"}),\" .\"]}),`\n`,(0,e.jsx)(t.div,{children:(0,e.jsx)(i,{alt:\"Virtual threads understanding\",src:\"/static/images/2022/what-are-virtual-threads/virtual-threads.png\",width:\"581\",height:\"325\"})}),`\n`,(0,e.jsxs)(t.h2,{id:\"virtual-threads-vs-platform-threads\",children:[(0,e.jsx)(t.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#virtual-threads-vs-platform-threads\",children:(0,e.jsx)(t.span,{className:\"icon icon-link\"})}),\"Virtual Threads vs Platform Threads\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"Virtual threads are daemon threads by default and \",(0,e.jsx)(t.strong,{children:\"cannot\"}),\" be changed by setting \",(0,e.jsx)(t.code,{children:\"Thread.setDaemon(false)\"}),\" . They always have a fixed priority and are set to normal priority. As of now, setting the \",(0,e.jsx)(t.code,{children:\"Thread.setPriority(int)\"}),\" has no effect but might change in later versions of the JDK.\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"Virtual threads do not support the \",(0,e.jsx)(t.code,{children:\"stop()\"}),\", \",(0,e.jsx)(t.code,{children:\"suspend()\"}),\", or \",(0,e.jsx)(t.code,{children:\"resume()\"}),\" methods and would throw an exception if invoked.\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"JDK 19 provides a new executor service \",(0,e.jsx)(t.code,{children:\"Executor.newVirtualThreadPerTaskExecutor()\"}),\" that creates Virtual threads for every submitted task. Alternatively, you can start a Virtual thread using \",(0,e.jsx)(t.code,{children:\"Thread.startVirtualThread(Runnable)\"}),\". You can use \",(0,e.jsx)(t.code,{children:\"Thread.isVirtual()\"}),\" to find out whether a thread is a Virtual thread or not.\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"Now, there is one important concept when it comes to Virtual threads being attached to a platform thread. A Virtual thread can be pinned to a platform-level thread when it executes code inside a \",(0,e.jsx)(t.code,{children:\"synchronized\"}),\" block or method.\"]}),`\n`,(0,e.jsxs)(t.p,{children:[\"In these cases, if the Virtual thread would be doing some blocking operation, then it would block the platform level thread, thus eventually blocking the kernel thread also. Hence it would be better to use locks over synchronized blocks or methods in such cases. To compensate for this, the number of platform-level threads may increase temporarily in the \",(0,e.jsx)(t.code,{children:\"ForkJoinPool\"}),\" Scheduler.\"]}),`\n`,(0,e.jsx)(t.p,{children:\"Finally, in terms of memory allocation, Virtual threads are stored on the heap as stack chunks. They can grow or shrink as the application progresses.\"}),`\n`,(0,e.jsxs)(t.p,{children:[\"When it comes to garbage collections, Virtual threads are not \",(0,e.jsx)(t.a,{href:\"https://www.baeldung.com/java-gc-roots\",children:\"GC roots\"}),\". This means if a Virtual thread is doing a blocking operation and no other thread has a reference to it, then the Virtual thread could be garbage collected.\"]}),`\n`,(0,e.jsxs)(t.h2,{id:\"conclusion\",children:[(0,e.jsx)(t.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#conclusion\",children:(0,e.jsx)(t.span,{className:\"icon icon-link\"})}),\"Conclusion\"]}),`\n`,(0,e.jsx)(t.p,{children:\"We just saw some of the concepts of Virtual threads and how they can be useful in increasing the throughput of non-CPU bound tasks. Virtual threads are cheap to create and we don't need to pool them.\"}),`\n`,(0,e.jsx)(t.p,{children:\"We can expect more changes coming up for Virtual threads in the upcoming JDK releases.\"}),`\n`,(0,e.jsxs)(t.p,{children:[\"I keep exploring and learning new things. If you want to know the latest trends and improve your software development skills, then subscribe to my newsletter below and also follow me on \",(0,e.jsx)(t.a,{href:\"https://twitter.com/amrutprabhu42\",children:\"Twitter\"}),\".\"]}),`\n`,(0,e.jsx)(t.p,{children:\"Enjoy!!\"})]})}}var y=k;function x(a,r){throw new Error(\"Expected \"+(r?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return V;})();\n;return Component;","toc":[{"value":"Introduction","url":"#introduction","depth":2},{"value":"What are Virtual Threads?","url":"#what-are-virtual-threads","depth":2},{"value":"How Virtual Threads Work","url":"#how-virtual-threads-work","depth":2},{"value":"Virtual Threads vs Platform Threads","url":"#virtual-threads-vs-platform-threads","depth":2},{"value":"Conclusion","url":"#conclusion","depth":2}],"frontMatter":{"readingTime":{"text":"5 min read","minutes":4.23,"time":253800,"words":846},"slug":"2022/what-are-virtual-threads-in-java","fileName":"2022/what-are-virtual-threads-in-java.md","title":"What Are Virtual Threads In Java","author":"Amrut Prabhu","categories":"","tags":["Java","JDK19","Virtual Threads","Multithreading"],"photo-credits":"https://unsplash.com/photos/NLgqFA9Lg_E","applaud-link":"2021/spring-boot-stream-kafka.json","date":"2022-12-15T00:00:00.000Z","draft":false,"summary":"We will look into the concepts of Virtual threads that are provided as a preview feature in JDK 19","imageUrl":"/static/images/2022/what-are-virtual-threads/cover.jpg","actualUrl":"2022/what-are-virtual-threads-in-java","customUrl":"what-are-virtual-threads-in-java"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.875,"time":52500,"words":175},"slug":["default"],"fileName":"default.md","name":"Amrut Prabhu","avatar":"/static/images/avatar-small.jpg","avatarBig":"/static/images/avatar-big.jpg","occupation":"Staff Engineer","company":"Personal","email":"contact@refactorfirst.com","twitter":"https://twitter.com/amrutprabhu42","linkedin":"https://www.linkedin.com/in/amrut-prabhu-722baa65/","github":"https://github.com/amrutprabhu","customUrl":"default","actualUrl":"default","date":null}],"prev":{"title":"Create Network Problems With Toxiproxy","author":"Amrut Prabhu","categories":"","tags":["Java","Spring Boot","Toxiproxy","Network"],"photo-credits":null,"applaud-link":"2021/spring-boot-stream-kafka.json","date":"2022-11-17T00:00:00.000Z","draft":false,"summary":"Here we look into using Toxiproxy to add network problems between systems communicating over the network","imageUrl":"/static/images/2022/introducing-network-problems-with-toxiproxy/cover.jpg","actualUrl":"2022/create-network-problems-with-toxiproxy","customUrl":"create-network-problems-with-toxiproxy","slug":"create-network-problems-with-toxiproxy"},"next":{"title":"Kick Start Spring Boot On AWS Lambda with Snap Start","author":"Amrut Prabhu","categories":"","tags":["Java","Spring Boot","AWS","AWS Lambda","Spring Cloud","Spring Cloud Functions"],"photo-credits":"https://unsplash.com/photos/NLgqFA9Lg_E","applaud-link":"2021/spring-boot-stream-kafka.json","date":"2023-01-26T00:00:00.000Z","draft":false,"summary":"We will look into how we can create an AWS Lambda with Terraform and run a Spring Boot application to view its performance with the Snap Start option enabled","imageUrl":"/static/images/2023/kick-start-spring-boot-on-lambda/cover.jpg","actualUrl":"2023/kick-start-spring-boot-application-with-aws-lambda-snap-start","customUrl":"kick-start-spring-boot-application-with-aws-lambda-snap-start","slug":"kick-start-spring-boot-application-with-aws-lambda-snap-start"}},"__N_SSG":true}